<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="theme" content="Chirpy v2.6.2"><meta name="generator" content="Jekyll v4.1.1" /><meta property="og:title" content="01-app启动流程分析" /><meta name="author" content="sleticalboy" /><meta property="og:locale" content="en_US" /><meta name="description" content="android 8.0 app 启动流程源码分析(一) 从点击桌面 app 图标到 ActivityThread 的 main() 方法执行" /><meta property="og:description" content="android 8.0 app 启动流程源码分析(一) 从点击桌面 app 图标到 ActivityThread 的 main() 方法执行" /><link rel="canonical" href="http://localhost:4001/posts/01-app%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90/" /><meta property="og:url" content="http://localhost:4001/posts/01-app%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90/" /><meta property="og:site_name" content="sleticalboy" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2020-12-02T10:19:11+08:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="01-app启动流程分析" /><meta name="twitter:site" content="@twitter_username" /><meta name="twitter:creator" content="@sleticalboy" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"headline":"01-app启动流程分析","dateModified":"2020-12-04T09:56:16+08:00","datePublished":"2020-12-02T10:19:11+08:00","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4001/posts/01-app%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90/"},"url":"http://localhost:4001/posts/01-app%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90/","author":{"@type":"Person","name":"sleticalboy"},"description":"android 8.0 app 启动流程源码分析(一) 从点击桌面 app 图标到 ActivityThread 的 main() 方法执行","@context":"https://schema.org"}</script><title>01-app启动流程分析 | sleticalboy</title><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon.png"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon-precomposed.png"><link rel="apple-touch-icon" sizes="57x57" href="/assets/img/favicons/apple-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/assets/img/favicons/apple-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/assets/img/favicons/apple-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/assets/img/favicons/apple-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/assets/img/favicons/apple-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/assets/img/favicons/apple-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/assets/img/favicons/apple-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/assets/img/favicons/apple-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-icon-180x180.png"><link rel="icon" type="image/png" sizes="192x192" href="/assets/img/favicons/android-icon-192x192.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="/assets/img/favicons/favicon-96x96.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/manifest.json"><meta name='msapplication-config' content='/assets/img/favicons/browserconfig.xml'><meta name="msapplication-TileColor" content="#ffffff"><meta name="msapplication-TileImage" content="/assets/img/favicons/ms-icon-144x144.png"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="cdn.jsdelivr.net"><link rel="dns-prefetch" href="cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha256-LA89z+k9fjgMKQ/kq4OO2Mrf8VltYml/VES+Rg0fh20=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css" integrity="sha256-+N4/V/SbAFiW1MPBCXnfnP9QSN3+Keu+NlB+0ev/YKQ=" crossorigin="anonymous"><link rel="preload" as="style" href="/assets/css/post.css"><link rel="stylesheet" href="/assets/css/post.css"><link rel="preload" as="style" href="/assets/css/lib/bootstrap-toc.min.css"><link rel="stylesheet" href="/assets/css/lib/bootstrap-toc.min.css" /> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script async src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script async src="/assets/js/post.min.js"></script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column"><div id="nav-wrapper"><div id="profile-wrapper" class="d-flex flex-column"><div id="avatar" class="d-flex justify-content-center"> <a href="/" alt="avatar"> <img src="/assets/img/sample/avatar.jpg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="profile-text mt-3"><div class="site-title"> <a href="/">sleticalboy</a></div><div class="site-subtitle font-italic">李斌的小站</div></div></div><ul class="nav flex-column"><li class="nav-item d-flex justify-content-center "> <a href="/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item d-flex justify-content-center "> <a href="/tabs/categories/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item d-flex justify-content-center "> <a href="/tabs/tags/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item d-flex justify-content-center "> <a href="/tabs/archives/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item d-flex justify-content-center "> <a href="/tabs/about/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul></div><div class="sidebar-bottom d-flex flex-wrap justify-content-around mt-4"> <span id="mode-toggle-wrapper"> <i class="mode-toggle fas fa-sun" dark-mode-invisible></i> <i class="mode-toggle fas fa-moon" light-mode-invisible></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.mode != null) { if (this.mode == ModeToggle.DARK_MODE) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.mode != null) { if (self.mode == ModeToggle.DARK_MODE) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span> <span class="icon-border"></span> <a href="https://github.com/sleticalboy" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/twitter_username" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['sleticalboy','gmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Posts </a> </span> <span>01-app启动流程分析</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>01-app启动流程分析</h1><div class="post-meta text-muted d-flex flex-column"><div> Posted <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Wed, Dec 2, 2020, 10:19 AM +0800" > Dec 2 <i class="unloaded">2020-12-02T10:19:11+08:00</i> </span> by <span class="author"> sleticalboy </span></div><div> Updated <span class="timeago lastmod" data-toggle="tooltip" data-placement="bottom" title="Fri, Dec 4, 2020, 9:56 AM +0800" > Dec 4 <i class="unloaded">2020-12-04T09:56:16+08:00</i> </span></div></div><div class="post-content"><h1 id="android-80-app-启动流程源码分析一">android 8.0 app 启动流程源码分析(一)</h1><blockquote><p>从点击桌面 app 图标到 ActivityThread 的 main() 方法执行</p></blockquote><h2 id="先来两张图先凑合下吧没找到合适的画图工具找到了再补上_">先来两张图(先凑合下吧，没找到合适的画图工具，找到了再补上=_=)</h2><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 " data-src="/android/assets/Launcher-Process.png" alt="Launcher-Process" /> <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 " data-src="/android/assets/Process-ActivityThread.png" alt="Process-ActivityThread" /></p><h2 id="launcher">Launcher</h2><p><code class="language-plaintext highlighter-rouge">/packages/apps/Launcher2/src/com/android/launcher2/Launcher.java</code></p><ul><li>什么是 Launcher<ul><li>通俗来讲，Launcher 就是我们常说的桌面，屏幕解锁后看到的界面就是 Launcher。<li>从代码层面来看 Launcher 本质上就是一个 Activity 并且实现了 View.onClickLister 接口，那就好说了，我们直接找到 onClick() 的具体实现。<div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">Launcher</span> <span class="kd">extends</span> <span class="nc">Activity</span> <span class="kd">implements</span> <span class="nc">View</span><span class="o">.</span><span class="na">OnClickListener</span><span class="o">,</span> 
    <span class="nc">OnLongClickListener</span><span class="o">,</span> <span class="nc">LauncherModel</span><span class="o">.</span><span class="na">Callbacks</span><span class="o">,</span> <span class="nc">View</span><span class="o">.</span><span class="na">OnTouchListener</span> <span class="o">{</span>    
    <span class="c1">// ... 省略</span>
<span class="o">}</span>
</pre></table></code></div></div></ul><li>Launcher#onClick()<div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre><td class="rouge-code"><pre><span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">onClick</span><span class="o">(</span><span class="nc">View</span> <span class="n">v</span><span class="o">)</span> <span class="o">{</span>
  <span class="nc">Object</span> <span class="n">tag</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="na">getTag</span><span class="o">();</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">tag</span> <span class="k">instanceof</span> <span class="nc">ShortcutInfo</span><span class="o">)</span> <span class="o">{</span>
      <span class="c1">// ShortcutInfo: 表示工作空间和文件夹中的可启动图标, 可以理解为我们的 app 启动图标</span>
      <span class="c1">// Open shortcut</span>
      <span class="kd">final</span> <span class="nc">Intent</span> <span class="n">intent</span> <span class="o">=</span> <span class="o">((</span><span class="nc">ShortcutInfo</span><span class="o">)</span> <span class="n">tag</span><span class="o">).</span><span class="na">intent</span><span class="o">;</span>
      <span class="kt">int</span><span class="o">[]</span> <span class="n">pos</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">int</span><span class="o">[</span><span class="mi">2</span><span class="o">];</span>
      <span class="n">v</span><span class="o">.</span><span class="na">getLocationOnScreen</span><span class="o">(</span><span class="n">pos</span><span class="o">);</span>
      <span class="n">intent</span><span class="o">.</span><span class="na">setSourceBounds</span><span class="o">(</span><span class="k">new</span> <span class="nc">Rect</span><span class="o">(</span><span class="n">pos</span><span class="o">[</span><span class="mi">0</span><span class="o">],</span> <span class="n">pos</span><span class="o">[</span><span class="mi">1</span><span class="o">],</span>
              <span class="n">pos</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span> <span class="o">+</span> <span class="n">v</span><span class="o">.</span><span class="na">getWidth</span><span class="o">(),</span> <span class="n">pos</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span> <span class="o">+</span> <span class="n">v</span><span class="o">.</span><span class="na">getHeight</span><span class="o">()));</span>
      <span class="c1">// 跳转到 Launcher#startActivitySafely()</span>
      <span class="kt">boolean</span> <span class="n">success</span> <span class="o">=</span> <span class="n">startActivitySafely</span><span class="o">(</span><span class="n">v</span><span class="o">,</span> <span class="n">intent</span><span class="o">,</span> <span class="n">tag</span><span class="o">);</span>
      <span class="c1">// ...</span>
  <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">tag</span> <span class="k">instanceof</span> <span class="nc">FolderInfo</span><span class="o">)</span> <span class="o">{</span>
      <span class="c1">// ...</span>
  <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">v</span> <span class="o">==</span> <span class="n">mAllAppsButton</span><span class="o">)</span> <span class="o">{</span>
      <span class="c1">// ...</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><li>Launcher#startActivitySafely()<div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre><span class="kt">boolean</span> <span class="nf">startActivitySafely</span><span class="o">(</span><span class="nc">View</span> <span class="n">v</span><span class="o">,</span> <span class="nc">Intent</span> <span class="n">intent</span><span class="o">,</span> <span class="nc">Object</span> <span class="n">tag</span><span class="o">)</span> <span class="o">{</span>
    <span class="kt">boolean</span> <span class="n">success</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="c1">// 跳转到 Launcher#startActivity();</span>
        <span class="n">success</span> <span class="o">=</span> <span class="n">startActivity</span><span class="o">(</span><span class="n">v</span><span class="o">,</span> <span class="n">intent</span><span class="o">,</span> <span class="n">tag</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">ActivityNotFoundException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// ...</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="n">success</span><span class="o">;</span>
<span class="o">}</span>
</pre></table></code></div></div><li>Launcher#startActivity()<div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
</pre><td class="rouge-code"><pre><span class="kt">boolean</span> <span class="nf">startActivity</span><span class="o">(</span><span class="nc">View</span> <span class="n">v</span><span class="o">,</span> <span class="nc">Intent</span> <span class="n">intent</span><span class="o">,</span> <span class="nc">Object</span> <span class="n">tag</span><span class="o">)</span> <span class="o">{</span>
  <span class="n">intent</span><span class="o">.</span><span class="na">addFlags</span><span class="o">(</span><span class="nc">Intent</span><span class="o">.</span><span class="na">FLAG_ACTIVITY_NEW_TASK</span><span class="o">);</span>
  <span class="k">try</span> <span class="o">{</span>
      <span class="c1">// Only launch using the new animation if the shortcut has not opted out (this is a</span>
      <span class="c1">// private contract between launcher and may be ignored in the future).</span>
      <span class="kt">boolean</span> <span class="n">useLaunchAnimation</span> <span class="o">=</span> <span class="o">(</span><span class="n">v</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">&amp;&amp;</span>
              <span class="o">!</span><span class="n">intent</span><span class="o">.</span><span class="na">hasExtra</span><span class="o">(</span><span class="no">INTENT_EXTRA_IGNORE_LAUNCH_ANIMATION</span><span class="o">);</span>
      <span class="nc">UserHandle</span> <span class="n">user</span> <span class="o">=</span> <span class="o">(</span><span class="nc">UserHandle</span><span class="o">)</span> <span class="n">intent</span><span class="o">.</span><span class="na">getParcelableExtra</span><span class="o">(</span><span class="nc">ApplicationInfo</span><span class="o">.</span><span class="na">EXTRA_PROFILE</span><span class="o">);</span>
      <span class="nc">LauncherApps</span> <span class="n">launcherApps</span> <span class="o">=</span> <span class="o">(</span><span class="nc">LauncherApps</span><span class="o">)</span>
              <span class="k">this</span><span class="o">.</span><span class="na">getSystemService</span><span class="o">(</span><span class="nc">Context</span><span class="o">.</span><span class="na">LAUNCHER_APPS_SERVICE</span><span class="o">);</span>
      <span class="c1">// 这里如果我们的 app 是从完全被杀死的状态唤起，会调用 startActivity() 方法，</span>
      <span class="c1">// 即 Activity#startActivity() 方法</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">useLaunchAnimation</span><span class="o">)</span> <span class="o">{</span>
          <span class="nc">ActivityOptions</span> <span class="n">opts</span> <span class="o">=</span> <span class="nc">ActivityOptions</span><span class="o">.</span><span class="na">makeScaleUpAnimation</span><span class="o">(</span><span class="n">v</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span>
                  <span class="n">v</span><span class="o">.</span><span class="na">getMeasuredWidth</span><span class="o">(),</span> <span class="n">v</span><span class="o">.</span><span class="na">getMeasuredHeight</span><span class="o">());</span>
          <span class="c1">// 这时候 user 还没被创建出来，UserHandle 与 pid 相关</span>
          <span class="k">if</span> <span class="o">(</span><span class="n">user</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">user</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">android</span><span class="o">.</span><span class="na">os</span><span class="o">.</span><span class="na">Process</span><span class="o">.</span><span class="na">myUserHandle</span><span class="o">()))</span> <span class="o">{</span>
              <span class="c1">// Could be launching some bookkeeping activity</span>
              <span class="n">startActivity</span><span class="o">(</span><span class="n">intent</span><span class="o">,</span> <span class="n">opts</span><span class="o">.</span><span class="na">toBundle</span><span class="o">());</span>
          <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
              <span class="c1">// ...</span>
          <span class="o">}</span>
      <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
          <span class="k">if</span> <span class="o">(</span><span class="n">user</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">user</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">android</span><span class="o">.</span><span class="na">os</span><span class="o">.</span><span class="na">Process</span><span class="o">.</span><span class="na">myUserHandle</span><span class="o">()))</span> <span class="o">{</span>
              <span class="n">startActivity</span><span class="o">(</span><span class="n">intent</span><span class="o">);</span>
          <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
              <span class="c1">// ...</span>
          <span class="o">}</span>
      <span class="o">}</span>
      <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
  <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">SecurityException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
      <span class="c1">// ...</span>
  <span class="o">}</span>
  <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
<span class="o">}</span>
</pre></table></code></div></div></ul><h2 id="activity">Activity</h2><p><code class="language-plaintext highlighter-rouge">/frameworks/base/core/java/android/app/Activity.java</code></p><ul><li>#startActivity()<li>#startActivityForResult(Intent intent, int requestCode, Bundle options);<div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kt">void</span> <span class="nf">startActivityForResult</span><span class="o">(</span><span class="nd">@RequiresPermission</span> <span class="nc">Intent</span> <span class="n">intent</span><span class="o">,</span> <span class="kt">int</span> <span class="n">requestCode</span><span class="o">,</span> <span class="nd">@Nullable</span> <span class="nc">Bundle</span> <span class="n">options</span><span class="o">)</span> <span class="o">{</span>
  <span class="c1">// 当 Activity 被创建的时候 mParent 才会被赋值，后面会看到</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">mParent</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">options</span> <span class="o">=</span> <span class="n">transferSpringboardActivityOptions</span><span class="o">(</span><span class="n">options</span><span class="o">);</span>
      <span class="nc">Instrumentation</span><span class="o">.</span><span class="na">ActivityResult</span> <span class="n">ar</span> <span class="o">=</span>
          <span class="n">mInstrumentation</span><span class="o">.</span><span class="na">execStartActivity</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">mMainThread</span><span class="o">.</span><span class="na">getApplicationThread</span><span class="o">(),</span> <span class="n">mToken</span><span class="o">,</span> <span class="k">this</span><span class="o">,</span> <span class="n">intent</span><span class="o">,</span> <span class="n">requestCode</span><span class="o">,</span> <span class="n">options</span><span class="o">);</span>
      <span class="c1">// ...</span>
  <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
      <span class="c1">// ...</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div></ul><h2 id="instrumentation">Instrumentation</h2><p><code class="language-plaintext highlighter-rouge">/frameworks/base/core/java/android/app/Instrumentation.java</code></p><ul><li>#execStartActivity()<div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="nc">ActivityResult</span> <span class="nf">execStartActivity</span><span class="o">(</span><span class="nc">Context</span> <span class="n">who</span><span class="o">,</span> <span class="nc">IBinder</span> <span class="n">contextThread</span><span class="o">,</span> <span class="nc">IBinder</span> <span class="n">token</span><span class="o">,</span> <span class="nc">Activity</span> <span class="n">target</span><span class="o">,</span>
      <span class="nc">Intent</span> <span class="n">intent</span><span class="o">,</span> <span class="kt">int</span> <span class="n">requestCode</span><span class="o">,</span> <span class="nc">Bundle</span> <span class="n">options</span><span class="o">)</span> <span class="o">{</span>
  <span class="nc">IApplicationThread</span> <span class="n">whoThread</span> <span class="o">=</span> <span class="o">(</span><span class="nc">IApplicationThread</span><span class="o">)</span> <span class="n">contextThread</span><span class="o">;</span>
  <span class="nc">Uri</span> <span class="n">referrer</span> <span class="o">=</span> <span class="n">target</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">?</span> <span class="n">target</span><span class="o">.</span><span class="na">onProvideReferrer</span><span class="o">()</span> <span class="o">:</span> <span class="kc">null</span><span class="o">;</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">referrer</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">intent</span><span class="o">.</span><span class="na">putExtra</span><span class="o">(</span><span class="nc">Intent</span><span class="o">.</span><span class="na">EXTRA_REFERRER</span><span class="o">,</span> <span class="n">referrer</span><span class="o">);</span>
  <span class="o">}</span>
  <span class="c1">// mActivityMonitors 的作用是记录新生成的 Activity ，目前不会走到这里，</span>
  <span class="c1">// 下面的 for 循环直接略过</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">mActivityMonitors</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
      <span class="kd">synchronized</span> <span class="o">(</span><span class="n">mSync</span><span class="o">)</span> <span class="o">{</span>
          <span class="c1">// ...</span>
      <span class="o">}</span>
  <span class="o">}</span>
  <span class="k">try</span> <span class="o">{</span>
      <span class="n">intent</span><span class="o">.</span><span class="na">migrateExtraStreamToClipData</span><span class="o">();</span>
      <span class="n">intent</span><span class="o">.</span><span class="na">prepareToLeaveProcess</span><span class="o">(</span><span class="n">who</span><span class="o">);</span>
      <span class="c1">// 这里调用了 AMS(ActivityManagerService) 的 startActivity() 方法</span>
      <span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="nc">ActivityManager</span><span class="o">.</span><span class="na">getService</span><span class="o">()</span>
          <span class="o">.</span><span class="na">startActivity</span><span class="o">(</span><span class="n">whoThread</span><span class="o">,</span> <span class="n">who</span><span class="o">.</span><span class="na">getBasePackageName</span><span class="o">(),</span> <span class="n">intent</span><span class="o">,</span>
                  <span class="n">intent</span><span class="o">.</span><span class="na">resolveTypeIfNeeded</span><span class="o">(</span><span class="n">who</span><span class="o">.</span><span class="na">getContentResolver</span><span class="o">()),</span>
                  <span class="n">token</span><span class="o">,</span> <span class="n">target</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">?</span> <span class="n">target</span><span class="o">.</span><span class="na">mEmbeddedID</span> <span class="o">:</span> <span class="kc">null</span><span class="o">,</span>
                  <span class="n">requestCode</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="n">options</span><span class="o">);</span>
      <span class="n">checkStartActivityResult</span><span class="o">(</span><span class="n">result</span><span class="o">,</span> <span class="n">intent</span><span class="o">);</span>
  <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">RemoteException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="s">"Failure from system"</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
  <span class="o">}</span>
  <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
<span class="o">}</span>
</pre></table></code></div></div></ul><h2 id="activitymanagerservice">ActivityManagerService</h2><p><code class="language-plaintext highlighter-rouge">/frameworks/base/services/core/java/com/android/server/am/ActivityManagerService.java</code></p><ul><li>#startActivity() -&gt; startActivityAsUser()<div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre><td class="rouge-code"><pre><span class="nd">@Override</span>
<span class="kd">public</span> <span class="kd">final</span> <span class="kt">int</span> <span class="nf">startActivityAsUser</span><span class="o">(</span><span class="nc">IApplicationThread</span> <span class="n">caller</span><span class="o">,</span> <span class="nc">String</span> <span class="n">callingPackage</span><span class="o">,</span>
      <span class="nc">Intent</span> <span class="n">intent</span><span class="o">,</span> <span class="nc">String</span> <span class="n">resolvedType</span><span class="o">,</span> <span class="nc">IBinder</span> <span class="n">resultTo</span><span class="o">,</span> <span class="nc">String</span> <span class="n">resultWho</span><span class="o">,</span> <span class="kt">int</span> <span class="n">requestCode</span><span class="o">,</span>
      <span class="kt">int</span> <span class="n">startFlags</span><span class="o">,</span> <span class="nc">ProfilerInfo</span> <span class="n">profilerInfo</span><span class="o">,</span> <span class="nc">Bundle</span> <span class="n">bOptions</span><span class="o">,</span> <span class="kt">int</span> <span class="n">userId</span><span class="o">)</span> <span class="o">{</span>
  <span class="n">enforceNotIsolatedCaller</span><span class="o">(</span><span class="s">"startActivity"</span><span class="o">);</span>
  <span class="n">userId</span> <span class="o">=</span> <span class="n">mUserController</span><span class="o">.</span><span class="na">handleIncomingUser</span><span class="o">(</span><span class="nc">Binder</span><span class="o">.</span><span class="na">getCallingPid</span><span class="o">(),</span> <span class="nc">Binder</span><span class="o">.</span><span class="na">getCallingUid</span><span class="o">(),</span>
          <span class="n">userId</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span> <span class="no">ALLOW_FULL_ONLY</span><span class="o">,</span> <span class="s">"startActivity"</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
  <span class="c1">// TODO: Switch to user app stacks here.</span>
  <span class="c1">// 调用 ActivityStarter#startActivityMayWait() 方法</span>
  <span class="k">return</span> <span class="n">mActivityStarter</span><span class="o">.</span><span class="na">startActivityMayWait</span><span class="o">(</span><span class="n">caller</span><span class="o">,</span> <span class="o">-</span><span class="mi">1</span><span class="o">,</span> <span class="n">callingPackage</span><span class="o">,</span> <span class="n">intent</span><span class="o">,</span>
          <span class="n">resolvedType</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="n">resultTo</span><span class="o">,</span> <span class="n">resultWho</span><span class="o">,</span> <span class="n">requestCode</span><span class="o">,</span> <span class="n">startFlags</span><span class="o">,</span>
          <span class="n">profilerInfo</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="n">bOptions</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span> <span class="n">userId</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span>
          <span class="s">"startActivityAsUser"</span><span class="o">);</span>
<span class="o">}</span>
</pre></table></code></div></div></ul><h2 id="activitystarter">ActivityStarter</h2><p><code class="language-plaintext highlighter-rouge">/frameworks/base/services/core/java/com/android/server/am/ActivityStarter.java</code></p><ul><li>ActivityStarter#startActivityMayWait()<div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
</pre><td class="rouge-code"><pre><span class="kd">final</span> <span class="kt">int</span> <span class="nf">startActivityMayWait</span><span class="o">(</span><span class="nc">IApplicationThread</span> <span class="n">caller</span><span class="o">,</span> <span class="kt">int</span> <span class="n">callingUid</span><span class="o">,</span>
      <span class="nc">String</span> <span class="n">callingPackage</span><span class="o">,</span> <span class="nc">Intent</span> <span class="n">intent</span><span class="o">,</span> <span class="nc">String</span> <span class="n">resolvedType</span><span class="o">,</span>
      <span class="nc">IVoiceInteractionSession</span> <span class="n">voiceSession</span><span class="o">,</span> <span class="nc">IVoiceInteractor</span> <span class="n">voiceInteractor</span><span class="o">,</span>
      <span class="nc">IBinder</span> <span class="n">resultTo</span><span class="o">,</span> <span class="nc">String</span> <span class="n">resultWho</span><span class="o">,</span> <span class="kt">int</span> <span class="n">requestCode</span><span class="o">,</span> <span class="kt">int</span> <span class="n">startFlags</span><span class="o">,</span>
      <span class="nc">ProfilerInfo</span> <span class="n">profilerInfo</span><span class="o">,</span> <span class="nc">WaitResult</span> <span class="n">outResult</span><span class="o">,</span>
      <span class="nc">Configuration</span> <span class="n">globalConfig</span><span class="o">,</span> <span class="nc">Bundle</span> <span class="n">bOptions</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">ignoreTargetSecurity</span><span class="o">,</span> <span class="kt">int</span> <span class="n">userId</span><span class="o">,</span>
      <span class="nc">IActivityContainer</span> <span class="n">iContainer</span><span class="o">,</span> <span class="nc">TaskRecord</span> <span class="n">inTask</span><span class="o">,</span> <span class="nc">String</span> <span class="n">reason</span><span class="o">)</span> <span class="o">{</span>
  <span class="c1">// ...</span>
  <span class="c1">// 收集 ResolveInfo</span>
  <span class="nc">ResolveInfo</span> <span class="n">rInfo</span> <span class="o">=</span> <span class="n">mSupervisor</span><span class="o">.</span><span class="na">resolveIntent</span><span class="o">(</span><span class="n">intent</span><span class="o">,</span> <span class="n">resolvedType</span><span class="o">,</span> <span class="n">userId</span><span class="o">);</span>
  <span class="c1">// ...</span>
  <span class="c1">// Collect information about the target of the Intent. 收集 ActivityInfo</span>
  <span class="nc">ActivityInfo</span> <span class="n">aInfo</span> <span class="o">=</span> <span class="n">mSupervisor</span><span class="o">.</span><span class="na">resolveActivity</span><span class="o">(</span><span class="n">intent</span><span class="o">,</span> <span class="n">rInfo</span><span class="o">,</span> <span class="n">startFlags</span><span class="o">,</span> <span class="n">profilerInfo</span><span class="o">);</span>

  <span class="nc">ActivityOptions</span> <span class="n">options</span> <span class="o">=</span> <span class="nc">ActivityOptions</span><span class="o">.</span><span class="na">fromBundle</span><span class="o">(</span><span class="n">bOptions</span><span class="o">);</span>
  <span class="nc">ActivityStackSupervisor</span><span class="o">.</span><span class="na">ActivityContainer</span> <span class="n">container</span> <span class="o">=</span>
          <span class="o">(</span><span class="nc">ActivityStackSupervisor</span><span class="o">.</span><span class="na">ActivityContainer</span><span class="o">)</span><span class="n">iContainer</span><span class="o">;</span>
  <span class="c1">// 收集 callingUid 和 callingPid</span>
  <span class="kd">synchronized</span> <span class="o">(</span><span class="n">mService</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">container</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">container</span><span class="o">.</span><span class="na">mParentActivity</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span>
              <span class="n">container</span><span class="o">.</span><span class="na">mParentActivity</span><span class="o">.</span><span class="na">state</span> <span class="o">!=</span> <span class="no">RESUMED</span><span class="o">)</span> <span class="o">{</span>
          <span class="c1">// Cannot start a child activity if the parent is not resumed.</span>
          <span class="k">return</span> <span class="nc">ActivityManager</span><span class="o">.</span><span class="na">START_CANCELED</span><span class="o">;</span>
      <span class="o">}</span>
      <span class="kd">final</span> <span class="kt">int</span> <span class="n">realCallingPid</span> <span class="o">=</span> <span class="nc">Binder</span><span class="o">.</span><span class="na">getCallingPid</span><span class="o">();</span>
      <span class="kd">final</span> <span class="kt">int</span> <span class="n">realCallingUid</span> <span class="o">=</span> <span class="nc">Binder</span><span class="o">.</span><span class="na">getCallingUid</span><span class="o">();</span>
      <span class="kt">int</span> <span class="n">callingPid</span><span class="o">;</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">callingUid</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
          <span class="n">callingPid</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="o">;</span>
      <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">caller</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
          <span class="n">callingPid</span> <span class="o">=</span> <span class="n">realCallingPid</span><span class="o">;</span>
          <span class="n">callingUid</span> <span class="o">=</span> <span class="n">realCallingUid</span><span class="o">;</span>
      <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
          <span class="n">callingPid</span> <span class="o">=</span> <span class="n">callingUid</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="o">;</span>
      <span class="o">}</span>

      <span class="kd">final</span> <span class="nc">ActivityStack</span> <span class="n">stack</span><span class="o">;</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">container</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">container</span><span class="o">.</span><span class="na">mStack</span><span class="o">.</span><span class="na">isOnHomeDisplay</span><span class="o">())</span> <span class="o">{</span>
          <span class="n">stack</span> <span class="o">=</span> <span class="n">mSupervisor</span><span class="o">.</span><span class="na">mFocusedStack</span><span class="o">;</span>
      <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
          <span class="n">stack</span> <span class="o">=</span> <span class="n">container</span><span class="o">.</span><span class="na">mStack</span><span class="o">;</span>
      <span class="o">}</span>
      <span class="n">stack</span><span class="o">.</span><span class="na">mConfigWillChange</span> <span class="o">=</span> <span class="n">globalConfig</span> <span class="o">!=</span> <span class="kc">null</span>
              <span class="o">&amp;&amp;</span> <span class="n">mService</span><span class="o">.</span><span class="na">getGlobalConfiguration</span><span class="o">().</span><span class="na">diff</span><span class="o">(</span><span class="n">globalConfig</span><span class="o">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="o">;</span>
      <span class="c1">// ...</span>
      <span class="kd">final</span> <span class="nc">ActivityRecord</span><span class="o">[]</span> <span class="n">outRecord</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ActivityRecord</span><span class="o">[</span><span class="mi">1</span><span class="o">];</span>
      <span class="c1">// 调用 startActivityLocked() 方法</span>
      <span class="kt">int</span> <span class="n">res</span> <span class="o">=</span> <span class="n">startActivityLocked</span><span class="o">(</span><span class="n">caller</span><span class="o">,</span> <span class="n">intent</span><span class="o">,</span> <span class="n">ephemeralIntent</span><span class="o">,</span> <span class="n">resolvedType</span><span class="o">,</span>
              <span class="n">aInfo</span><span class="o">,</span> <span class="n">rInfo</span><span class="o">,</span> <span class="n">voiceSession</span><span class="o">,</span> <span class="n">voiceInteractor</span><span class="o">,</span>
              <span class="n">resultTo</span><span class="o">,</span> <span class="n">resultWho</span><span class="o">,</span> <span class="n">requestCode</span><span class="o">,</span> <span class="n">callingPid</span><span class="o">,</span>
              <span class="n">callingUid</span><span class="o">,</span> <span class="n">callingPackage</span><span class="o">,</span> <span class="n">realCallingPid</span><span class="o">,</span> <span class="n">realCallingUid</span><span class="o">,</span> <span class="n">startFlags</span><span class="o">,</span>
              <span class="n">options</span><span class="o">,</span> <span class="n">ignoreTargetSecurity</span><span class="o">,</span> <span class="n">componentSpecified</span><span class="o">,</span> <span class="n">outRecord</span><span class="o">,</span> <span class="n">container</span><span class="o">,</span>
              <span class="n">inTask</span><span class="o">,</span> <span class="n">reason</span><span class="o">);</span>
      <span class="nc">Binder</span><span class="o">.</span><span class="na">restoreCallingIdentity</span><span class="o">(</span><span class="n">origId</span><span class="o">);</span>
      <span class="c1">// ...</span>
      <span class="k">return</span> <span class="n">res</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><li>ActivityStarter#startActivityLocked()<div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre><td class="rouge-code"><pre><span class="kt">int</span> <span class="nf">startActivityLocked</span><span class="o">(</span><span class="nc">IApplicationThread</span> <span class="n">caller</span><span class="o">,</span> <span class="nc">Intent</span> <span class="n">intent</span><span class="o">,</span> <span class="nc">Intent</span> <span class="n">ephemeralIntent</span><span class="o">,</span>
      <span class="nc">String</span> <span class="n">resolvedType</span><span class="o">,</span> <span class="nc">ActivityInfo</span> <span class="n">aInfo</span><span class="o">,</span> <span class="nc">ResolveInfo</span> <span class="n">rInfo</span><span class="o">,</span>
      <span class="nc">IVoiceInteractionSession</span> <span class="n">voiceSession</span><span class="o">,</span> <span class="nc">IVoiceInteractor</span> <span class="n">voiceInteractor</span><span class="o">,</span>
      <span class="nc">IBinder</span> <span class="n">resultTo</span><span class="o">,</span> <span class="nc">String</span> <span class="n">resultWho</span><span class="o">,</span> <span class="kt">int</span> <span class="n">requestCode</span><span class="o">,</span> <span class="kt">int</span> <span class="n">callingPid</span><span class="o">,</span> <span class="kt">int</span> <span class="n">callingUid</span><span class="o">,</span>
      <span class="nc">String</span> <span class="n">callingPackage</span><span class="o">,</span> <span class="kt">int</span> <span class="n">realCallingPid</span><span class="o">,</span> <span class="kt">int</span> <span class="n">realCallingUid</span><span class="o">,</span> <span class="kt">int</span> <span class="n">startFlags</span><span class="o">,</span>
      <span class="nc">ActivityOptions</span> <span class="n">options</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">ignoreTargetSecurity</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">componentSpecified</span><span class="o">,</span>
      <span class="nc">ActivityRecord</span><span class="o">[]</span> <span class="n">outActivity</span><span class="o">,</span> <span class="nc">ActivityStackSupervisor</span><span class="o">.</span><span class="na">ActivityContainer</span> <span class="n">container</span><span class="o">,</span>
      <span class="nc">TaskRecord</span> <span class="n">inTask</span><span class="o">,</span> <span class="nc">String</span> <span class="n">reason</span><span class="o">)</span> <span class="o">{</span>
  <span class="c1">// ...</span>
  <span class="c1">// 调用 startActivity() 方法</span>
  <span class="n">mLastStartActivityResult</span> <span class="o">=</span> <span class="n">startActivity</span><span class="o">(</span><span class="n">caller</span><span class="o">,</span> <span class="n">intent</span><span class="o">,</span> <span class="n">ephemeralIntent</span><span class="o">,</span> <span class="n">resolvedType</span><span class="o">,</span>
          <span class="n">aInfo</span><span class="o">,</span> <span class="n">rInfo</span><span class="o">,</span> <span class="n">voiceSession</span><span class="o">,</span> <span class="n">voiceInteractor</span><span class="o">,</span> <span class="n">resultTo</span><span class="o">,</span> <span class="n">resultWho</span><span class="o">,</span> <span class="n">requestCode</span><span class="o">,</span>
          <span class="n">callingPid</span><span class="o">,</span> <span class="n">callingUid</span><span class="o">,</span> <span class="n">callingPackage</span><span class="o">,</span> <span class="n">realCallingPid</span><span class="o">,</span> <span class="n">realCallingUid</span><span class="o">,</span> <span class="n">startFlags</span><span class="o">,</span>
          <span class="n">options</span><span class="o">,</span> <span class="n">ignoreTargetSecurity</span><span class="o">,</span> <span class="n">componentSpecified</span><span class="o">,</span> <span class="n">mLastStartActivityRecord</span><span class="o">,</span>
          <span class="n">container</span><span class="o">,</span> <span class="n">inTask</span><span class="o">);</span>
  <span class="c1">// ...</span>
  <span class="k">return</span> <span class="n">mLastStartActivityResult</span><span class="o">;</span>
<span class="o">}</span>
</pre></table></code></div></div><li>ActivityStarter#startActivity(23个参数) -&gt; 调用 startActivity(9个参数) [重载方法]<div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre><td class="rouge-code"><pre><span class="kd">private</span> <span class="kt">int</span> <span class="nf">startActivity</span><span class="o">(</span><span class="kd">final</span> <span class="nc">ActivityRecord</span> <span class="n">r</span><span class="o">,</span> <span class="nc">ActivityRecord</span> <span class="n">sourceRecord</span><span class="o">,</span>
      <span class="nc">IVoiceInteractionSession</span> <span class="n">voiceSession</span><span class="o">,</span> <span class="nc">IVoiceInteractor</span> <span class="n">voiceInteractor</span><span class="o">,</span>
      <span class="kt">int</span> <span class="n">startFlags</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">doResume</span><span class="o">,</span> <span class="nc">ActivityOptions</span> <span class="n">options</span><span class="o">,</span> <span class="nc">TaskRecord</span> <span class="n">inTask</span><span class="o">,</span>
      <span class="nc">ActivityRecord</span><span class="o">[]</span> <span class="n">outActivity</span><span class="o">)</span> <span class="o">{</span>
  <span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="no">START_CANCELED</span><span class="o">;</span>
  <span class="k">try</span> <span class="o">{</span>
      <span class="n">mService</span><span class="o">.</span><span class="na">mWindowManager</span><span class="o">.</span><span class="na">deferSurfaceLayout</span><span class="o">();</span>
      <span class="c1">// 调用 startActivityUnchecked() 方法</span>
      <span class="n">result</span> <span class="o">=</span> <span class="n">startActivityUnchecked</span><span class="o">(</span><span class="n">r</span><span class="o">,</span> <span class="n">sourceRecord</span><span class="o">,</span> <span class="n">voiceSession</span><span class="o">,</span> <span class="n">voiceInteractor</span><span class="o">,</span>
              <span class="n">startFlags</span><span class="o">,</span> <span class="n">doResume</span><span class="o">,</span> <span class="n">options</span><span class="o">,</span> <span class="n">inTask</span><span class="o">,</span> <span class="n">outActivity</span><span class="o">);</span>
  <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
      <span class="c1">// ...</span>
  <span class="o">}</span>
  <span class="c1">// 通知 Activity 正在处理</span>
  <span class="n">postStartActivityProcessing</span><span class="o">(</span><span class="n">r</span><span class="o">,</span> <span class="n">result</span><span class="o">,</span> <span class="n">mSupervisor</span><span class="o">.</span><span class="na">getLastStack</span><span class="o">().</span><span class="na">mStackId</span><span class="o">,</span>  <span class="n">mSourceRecord</span><span class="o">,</span>
          <span class="n">mTargetStack</span><span class="o">);</span>
  <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
<span class="o">}</span>
</pre></table></code></div></div><li>ActivityStarter#startActivityUnchecked()<div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
</pre><td class="rouge-code"><pre><span class="kd">private</span> <span class="kt">int</span> <span class="nf">startActivityUnchecked</span><span class="o">(</span><span class="kd">final</span> <span class="nc">ActivityRecord</span> <span class="n">r</span><span class="o">,</span> <span class="nc">ActivityRecord</span> <span class="n">sourceRecord</span><span class="o">,</span>
      <span class="nc">IVoiceInteractionSession</span> <span class="n">voiceSession</span><span class="o">,</span> <span class="nc">IVoiceInteractor</span> <span class="n">voiceInteractor</span><span class="o">,</span>
      <span class="kt">int</span> <span class="n">startFlags</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">doResume</span><span class="o">,</span> <span class="nc">ActivityOptions</span> <span class="n">options</span><span class="o">,</span> <span class="nc">TaskRecord</span> <span class="n">inTask</span><span class="o">,</span>
      <span class="nc">ActivityRecord</span><span class="o">[]</span> <span class="n">outActivity</span><span class="o">)</span> <span class="o">{</span>
  <span class="c1">// 这个函数会把 doResume 参数赋值给 mDoResume 字段</span>
  <span class="n">setInitialState</span><span class="o">(</span><span class="n">r</span><span class="o">,</span> <span class="n">options</span><span class="o">,</span> <span class="n">inTask</span><span class="o">,</span> <span class="n">doResume</span><span class="o">,</span> <span class="n">startFlags</span><span class="o">,</span> <span class="n">sourceRecord</span><span class="o">,</span> <span class="n">voiceSession</span><span class="o">,</span> <span class="n">voiceInteractor</span><span class="o">);</span>
  <span class="c1">// ... 看是否有重用的 Activity</span>
  <span class="nc">ActivityRecord</span> <span class="n">reusedActivity</span> <span class="o">=</span> <span class="n">getReusableIntentActivity</span><span class="o">();</span>
  <span class="c1">// ... 这时候 reusedActivity 为 null, 直接略过以下逻辑</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">reusedActivity</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
      <span class="c1">// ...</span>
  <span class="o">}</span>
  <span class="c1">// ... 上面传过来的参数 doResume = true</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">mDoResume</span><span class="o">)</span> <span class="o">{</span>
      <span class="kd">final</span> <span class="nc">ActivityRecord</span> <span class="n">topTaskActivity</span> <span class="o">=</span>
              <span class="n">mStartActivity</span><span class="o">.</span><span class="na">getTask</span><span class="o">().</span><span class="na">topRunningActivityLocked</span><span class="o">();</span>
      <span class="k">if</span> <span class="o">(!</span><span class="n">mTargetStack</span><span class="o">.</span><span class="na">isFocusable</span><span class="o">()</span>
              <span class="o">||</span> <span class="o">(</span><span class="n">topTaskActivity</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">topTaskActivity</span><span class="o">.</span><span class="na">mTaskOverlay</span>
              <span class="o">&amp;&amp;</span> <span class="n">mStartActivity</span> <span class="o">!=</span> <span class="n">topTaskActivity</span><span class="o">))</span> <span class="o">{</span>
          <span class="c1">// If the activity is not focusable, we can't resume it, but still would like to</span>
          <span class="c1">// make sure it becomes visible as it starts (this will also trigger entry</span>
          <span class="c1">// animation). An example of this are PIP activities.</span>
          <span class="c1">// Also, we don't want to resume activities in a task that currently has an overlay</span>
          <span class="c1">// as the starting activity just needs to be in the visible paused state until the</span>
          <span class="c1">// over is removed.</span>
          <span class="n">mTargetStack</span><span class="o">.</span><span class="na">ensureActivitiesVisibleLocked</span><span class="o">(</span><span class="kc">null</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="o">!</span><span class="no">PRESERVE_WINDOWS</span><span class="o">);</span>
          <span class="c1">// Go ahead and tell window manager to execute app transition for this activity</span>
          <span class="c1">// since the app transition will not be triggered through the resume channel.</span>
          <span class="n">mWindowManager</span><span class="o">.</span><span class="na">executeAppTransition</span><span class="o">();</span>
      <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
          <span class="c1">// If the target stack was not previously focusable (previous top running activity</span>
          <span class="c1">// on that stack was not visible) then any prior calls to move the stack to the</span>
          <span class="c1">// will not update the focused stack.  If starting the new activity now allows the</span>
          <span class="c1">// task stack to be focusable, then ensure that we now update the focused stack</span>
          <span class="c1">// accordingly.</span>
          <span class="k">if</span> <span class="o">(</span><span class="n">mTargetStack</span><span class="o">.</span><span class="na">isFocusable</span><span class="o">()</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">mSupervisor</span><span class="o">.</span><span class="na">isFocusedStack</span><span class="o">(</span><span class="n">mTargetStack</span><span class="o">))</span> <span class="o">{</span>
              <span class="n">mTargetStack</span><span class="o">.</span><span class="na">moveToFront</span><span class="o">(</span><span class="s">"startActivityUnchecked"</span><span class="o">);</span>
          <span class="o">}</span>
          <span class="c1">// 调用 ActivityStackSupervisor#resumeFocusedStackTopActivityLocked() 方法</span>
          <span class="n">mSupervisor</span><span class="o">.</span><span class="na">resumeFocusedStackTopActivityLocked</span><span class="o">(</span><span class="n">mTargetStack</span><span class="o">,</span> <span class="n">mStartActivity</span><span class="o">,</span>
                  <span class="n">mOptions</span><span class="o">);</span>
      <span class="o">}</span>
  <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
      <span class="n">mTargetStack</span><span class="o">.</span><span class="na">addRecentActivityLocked</span><span class="o">(</span><span class="n">mStartActivity</span><span class="o">);</span>
  <span class="o">}</span>
  <span class="c1">// ...</span>
  <span class="k">return</span> <span class="no">START_SUCCESS</span><span class="o">;</span>
<span class="o">}</span>
</pre></table></code></div></div><li>调用 ActivityStackSupervisor#resumeFocusedStackTopActivityLocked() 方法</ul><h2 id="activitystacksupervisor">ActivityStackSupervisor</h2><p><code class="language-plaintext highlighter-rouge">/frameworks/base/services/core/java/com/android/server/am/ActivityStackSupervisor.java</code></p><ul><li>#resumeFocusedStackTopActivityLocked() -&gt; 调用 ActivityStack#resumeTopActivityUncheckedLocked() 方法</ul><h2 id="activitystack">ActivityStack</h2><p><code class="language-plaintext highlighter-rouge">/frameworks/base/services/core/java/com/android/server/am/ActivityStack.java</code></p><ul><li>#resumeTopActivityUncheckedLocked() -&gt; 调用 resumeTopActivityInnerLocked()<div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre><span class="kd">private</span> <span class="kt">boolean</span> <span class="nf">resumeTopActivityInnerLocked</span><span class="o">(</span><span class="nc">ActivityRecord</span> <span class="n">prev</span><span class="o">,</span> <span class="nc">ActivityOptions</span> <span class="n">options</span><span class="o">)</span> <span class="o">{</span>
  <span class="c1">// ... 这里面的判断逻辑比较多, 我们只看重点</span>
  <span class="nc">ActivityStack</span> <span class="n">lastStack</span> <span class="o">=</span> <span class="n">mStackSupervisor</span><span class="o">.</span><span class="na">getLastStack</span><span class="o">();</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">next</span><span class="o">.</span><span class="na">app</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">next</span><span class="o">.</span><span class="na">app</span><span class="o">.</span><span class="na">thread</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
      <span class="c1">// ... 这个 if 是不会进的，因为 next.app.thread 为 null，所以先略过</span>
  <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
      <span class="c1">// ... 调用回到了 ActivityStackSupervisor#startSpecificActivityLocked() 方法</span>
      <span class="n">mStackSupervisor</span><span class="o">.</span><span class="na">startSpecificActivityLocked</span><span class="o">(</span><span class="n">next</span><span class="o">,</span> <span class="kc">true</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>
  <span class="o">}</span>
  <span class="c1">// ...</span>
  <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
<span class="o">}</span>
</pre></table></code></div></div><li>ActivityStackSupervisor#startSpecificActivityLocked() 方法<div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre><td class="rouge-code"><pre><span class="kt">void</span> <span class="nf">startSpecificActivityLocked</span><span class="o">(</span><span class="nc">ActivityRecord</span> <span class="n">r</span><span class="o">,</span>
      <span class="kt">boolean</span> <span class="n">andResume</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">checkConfig</span><span class="o">)</span> <span class="o">{</span>
  <span class="c1">// Is this activity's application already running?</span>
  <span class="nc">ProcessRecord</span> <span class="n">app</span> <span class="o">=</span> <span class="n">mService</span><span class="o">.</span><span class="na">getProcessRecordLocked</span><span class="o">(</span><span class="n">r</span><span class="o">.</span><span class="na">processName</span><span class="o">,</span> <span class="n">r</span><span class="o">.</span><span class="na">info</span><span class="o">.</span><span class="na">applicationInfo</span><span class="o">.</span><span class="na">uid</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>
  <span class="n">r</span><span class="o">.</span><span class="na">getStack</span><span class="o">().</span><span class="na">setLaunchTime</span><span class="o">(</span><span class="n">r</span><span class="o">);</span>

  <span class="c1">// 判断进程是否存在</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">app</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">app</span><span class="o">.</span><span class="na">thread</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">try</span> <span class="o">{</span>
          <span class="c1">// ... 当进程存在时会调用此方法</span>
          <span class="n">realStartActivityLocked</span><span class="o">(</span><span class="n">r</span><span class="o">,</span> <span class="n">app</span><span class="o">,</span> <span class="n">andResume</span><span class="o">,</span> <span class="n">checkConfig</span><span class="o">);</span>
          <span class="k">return</span><span class="o">;</span>
      <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">RemoteException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
          <span class="c1">// ...</span>
      <span class="o">}</span>
      <span class="c1">// If a dead object exception was thrown -- fall through to</span>
      <span class="c1">// restart the application.</span>
  <span class="o">}</span>
  <span class="c1">// 因为是启动应用，所以直接看这里 调用 AMS#startProcessLocked() 方法</span>
  <span class="n">mService</span><span class="o">.</span><span class="na">startProcessLocked</span><span class="o">(</span><span class="n">r</span><span class="o">.</span><span class="na">processName</span><span class="o">,</span> <span class="n">r</span><span class="o">.</span><span class="na">info</span><span class="o">.</span><span class="na">applicationInfo</span><span class="o">,</span> <span class="kc">true</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span>
          <span class="s">"activity"</span><span class="o">,</span> <span class="n">r</span><span class="o">.</span><span class="na">intent</span><span class="o">.</span><span class="na">getComponent</span><span class="o">(),</span> <span class="kc">false</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>
<span class="o">}</span>
</pre></table></code></div></div><li>AMS#startProcessLocked() -&gt; AMS#startProcessLocked(6个参数) -&gt; Progress.start()<div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
</pre><td class="rouge-code"><pre><span class="kd">private</span> <span class="kd">final</span> <span class="kt">void</span> <span class="nf">startProcessLocked</span><span class="o">(</span><span class="nc">ProcessRecord</span> <span class="n">app</span><span class="o">,</span> <span class="nc">String</span> <span class="n">hostingType</span><span class="o">,</span>
      <span class="nc">String</span> <span class="n">hostingNameStr</span><span class="o">,</span> <span class="nc">String</span> <span class="n">abiOverride</span><span class="o">,</span> <span class="nc">String</span> <span class="n">entryPoint</span><span class="o">,</span> <span class="nc">String</span><span class="o">[]</span> <span class="n">entryPointArgs</span><span class="o">)</span> <span class="o">{</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">app</span><span class="o">.</span><span class="na">pid</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">app</span><span class="o">.</span><span class="na">pid</span> <span class="o">!=</span> <span class="no">MY_PID</span><span class="o">)</span> <span class="o">{</span>
      <span class="c1">// ... 这里的 app 是 通过 newProcessRecordLocked() 方法得到的</span>
      <span class="c1">// 此时 app.pid 还没被赋值， 默认是 0 所以这里的 if 语句可以先略过</span>
  <span class="o">}</span>
  <span class="k">try</span> <span class="o">{</span>
      <span class="c1">// ... PMS 检查包状态，如果是不可启动状态将抛出 RuntimeException</span>
      <span class="kt">int</span> <span class="n">uid</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="na">uid</span><span class="o">;</span>
      <span class="kt">int</span><span class="o">[]</span> <span class="n">gids</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
      <span class="kt">int</span> <span class="n">mountExternal</span> <span class="o">=</span> <span class="nc">Zygote</span><span class="o">.</span><span class="na">MOUNT_EXTERNAL_NONE</span><span class="o">;</span>
      <span class="kt">int</span> <span class="n">debugFlags</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>

      <span class="nc">String</span> <span class="n">invokeWith</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
      <span class="nc">String</span> <span class="n">requiredAbi</span> <span class="o">=</span> <span class="o">(</span><span class="n">abiOverride</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">?</span> <span class="n">abiOverride</span> <span class="o">:</span> <span class="n">app</span><span class="o">.</span><span class="na">info</span><span class="o">.</span><span class="na">primaryCpuAbi</span><span class="o">;</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">requiredAbi</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
          <span class="n">requiredAbi</span> <span class="o">=</span> <span class="nc">Build</span><span class="o">.</span><span class="na">SUPPORTED_ABIS</span><span class="o">[</span><span class="mi">0</span><span class="o">];</span>
      <span class="o">}</span>

      <span class="nc">String</span> <span class="n">instructionSet</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">app</span><span class="o">.</span><span class="na">info</span><span class="o">.</span><span class="na">primaryCpuAbi</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
          <span class="n">instructionSet</span> <span class="o">=</span> <span class="nc">VMRuntime</span><span class="o">.</span><span class="na">getInstructionSet</span><span class="o">(</span><span class="n">app</span><span class="o">.</span><span class="na">info</span><span class="o">.</span><span class="na">primaryCpuAbi</span><span class="o">);</span>
      <span class="o">}</span>

      <span class="n">app</span><span class="o">.</span><span class="na">gids</span> <span class="o">=</span> <span class="n">gids</span><span class="o">;</span>
      <span class="n">app</span><span class="o">.</span><span class="na">requiredAbi</span> <span class="o">=</span> <span class="n">requiredAbi</span><span class="o">;</span>
      <span class="n">app</span><span class="o">.</span><span class="na">instructionSet</span> <span class="o">=</span> <span class="n">instructionSet</span><span class="o">;</span>

      <span class="c1">// the per-user SELinux context must be set</span>
      <span class="kd">final</span> <span class="nc">String</span> <span class="n">seInfo</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="na">info</span><span class="o">.</span><span class="na">seInfo</span>
              <span class="o">+</span> <span class="o">(</span><span class="nc">TextUtils</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">(</span><span class="n">app</span><span class="o">.</span><span class="na">info</span><span class="o">.</span><span class="na">seInfoUser</span><span class="o">)</span> <span class="o">?</span> <span class="s">""</span> <span class="o">:</span> <span class="n">app</span><span class="o">.</span><span class="na">info</span><span class="o">.</span><span class="na">seInfoUser</span><span class="o">);</span>
      <span class="c1">// Start the process.  It will either succeed and return a result containing</span>
      <span class="c1">// the PID of the new process, or else throw a RuntimeException.</span>
      <span class="kt">boolean</span> <span class="n">isActivityProcess</span> <span class="o">=</span> <span class="o">(</span><span class="n">entryPoint</span> <span class="o">==</span> <span class="kc">null</span><span class="o">);</span>
      <span class="c1">// 看到这一行，有没有很熟悉，我们离目的地好像不远了，通过上面传过来的参数来看 entryPoint </span>
      <span class="c1">// 为 null, 这里直接赋值为 "android.app.ActivityThread"</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">entryPoint</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="n">entryPoint</span> <span class="o">=</span> <span class="s">"android.app.ActivityThread"</span><span class="o">;</span>
      <span class="nc">ProcessStartResult</span> <span class="n">startResult</span><span class="o">;</span>
      <span class="c1">// 此时的 hostingType = "activity"</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">hostingType</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">"webview_service"</span><span class="o">))</span> <span class="o">{</span>
          <span class="c1">// ... WebView 进程逻辑略过</span>
      <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
          <span class="c1">// 启动进程 这里是一个 socket 通信，在 startResult 里返回 pid 等信息</span>
          <span class="n">startResult</span> <span class="o">=</span> <span class="nc">Process</span><span class="o">.</span><span class="na">start</span><span class="o">(</span><span class="n">entryPoint</span><span class="o">,</span>
                  <span class="n">app</span><span class="o">.</span><span class="na">processName</span><span class="o">,</span> <span class="n">uid</span><span class="o">,</span> <span class="n">uid</span><span class="o">,</span> <span class="n">gids</span><span class="o">,</span> <span class="n">debugFlags</span><span class="o">,</span> <span class="n">mountExternal</span><span class="o">,</span>
                  <span class="n">app</span><span class="o">.</span><span class="na">info</span><span class="o">.</span><span class="na">targetSdkVersion</span><span class="o">,</span> <span class="n">seInfo</span><span class="o">,</span> <span class="n">requiredAbi</span><span class="o">,</span> <span class="n">instructionSet</span><span class="o">,</span>
                  <span class="n">app</span><span class="o">.</span><span class="na">info</span><span class="o">.</span><span class="na">dataDir</span><span class="o">,</span> <span class="n">invokeWith</span><span class="o">,</span> <span class="n">entryPointArgs</span><span class="o">);</span>
      <span class="o">}</span>
      <span class="c1">// 到这里 app.pid 才被赋值</span>
      <span class="n">app</span><span class="o">.</span><span class="na">setPid</span><span class="o">(</span><span class="n">startResult</span><span class="o">.</span><span class="na">pid</span><span class="o">);</span>
      <span class="n">app</span><span class="o">.</span><span class="na">usingWrapper</span> <span class="o">=</span> <span class="n">startResult</span><span class="o">.</span><span class="na">usingWrapper</span><span class="o">;</span>
      <span class="n">app</span><span class="o">.</span><span class="na">removed</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
      <span class="n">app</span><span class="o">.</span><span class="na">killed</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
      <span class="n">app</span><span class="o">.</span><span class="na">killedByAm</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
      <span class="nc">ProcessRecord</span> <span class="n">oldApp</span><span class="o">;</span>
      <span class="kd">synchronized</span> <span class="o">(</span><span class="n">mPidsSelfLocked</span><span class="o">)</span> <span class="o">{</span>
          <span class="n">oldApp</span> <span class="o">=</span> <span class="n">mPidsSelfLocked</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">startResult</span><span class="o">.</span><span class="na">pid</span><span class="o">);</span>
      <span class="o">}</span>
      <span class="c1">// If there is already an app occupying that pid that hasn't been cleaned up</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">oldApp</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">app</span><span class="o">.</span><span class="na">isolated</span><span class="o">)</span> <span class="o">{</span>
          <span class="c1">// Clean up anything relating to this pid first</span>
          <span class="n">cleanUpApplicationRecordLocked</span><span class="o">(</span><span class="n">oldApp</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span> <span class="o">-</span><span class="mi">1</span><span class="o">,</span>
                  <span class="kc">true</span> <span class="cm">/*replacingPid*/</span><span class="o">);</span>
      <span class="o">}</span>
      <span class="kd">synchronized</span> <span class="o">(</span><span class="n">mPidsSelfLocked</span><span class="o">)</span> <span class="o">{</span>
          <span class="k">this</span><span class="o">.</span><span class="na">mPidsSelfLocked</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">startResult</span><span class="o">.</span><span class="na">pid</span><span class="o">,</span> <span class="n">app</span><span class="o">);</span>
          <span class="k">if</span> <span class="o">(</span><span class="n">isActivityProcess</span><span class="o">)</span> <span class="o">{</span>
              <span class="nc">Message</span> <span class="n">msg</span> <span class="o">=</span> <span class="n">mHandler</span><span class="o">.</span><span class="na">obtainMessage</span><span class="o">(</span><span class="no">PROC_START_TIMEOUT_MSG</span><span class="o">);</span>
              <span class="n">msg</span><span class="o">.</span><span class="na">obj</span> <span class="o">=</span> <span class="n">app</span><span class="o">;</span>
              <span class="n">mHandler</span><span class="o">.</span><span class="na">sendMessageDelayed</span><span class="o">(</span><span class="n">msg</span><span class="o">,</span> <span class="n">startResult</span><span class="o">.</span><span class="na">usingWrapper</span>
                      <span class="o">?</span> <span class="no">PROC_START_TIMEOUT_WITH_WRAPPER</span> <span class="o">:</span> <span class="no">PROC_START_TIMEOUT</span><span class="o">);</span>
          <span class="o">}</span>
      <span class="o">}</span>
  <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">RuntimeException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
      <span class="c1">// ...</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div></ul><h2 id="process">Process</h2><p><code class="language-plaintext highlighter-rouge">/frameworks/base/core/java/android/os/Process.java</code></p><ul><li>#start() -&gt; Progress.zygoteProcess.start()<div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">final</span> <span class="nc">Process</span><span class="o">.</span><span class="na">ProcessStartResult</span> <span class="nf">start</span><span class="o">(</span><span class="kd">final</span> <span class="nc">String</span> <span class="n">processClass</span><span class="o">,</span> 
  <span class="kd">final</span> <span class="nc">String</span> <span class="n">niceName</span><span class="o">,</span> <span class="kt">int</span> <span class="n">uid</span><span class="o">,</span> <span class="kt">int</span> <span class="n">gid</span><span class="o">,</span> <span class="kt">int</span><span class="o">[]</span> <span class="n">gids</span><span class="o">,</span> <span class="kt">int</span> <span class="n">debugFlags</span><span class="o">,</span> <span class="kt">int</span> <span class="n">mountExternal</span><span class="o">,</span>
  <span class="kt">int</span> <span class="n">targetSdkVersion</span><span class="o">,</span> <span class="nc">String</span> <span class="n">seInfo</span><span class="o">,</span> <span class="nc">String</span> <span class="n">abi</span><span class="o">,</span> <span class="nc">String</span> <span class="n">instructionSet</span><span class="o">,</span> <span class="nc">String</span> <span class="n">appDataDir</span><span class="o">,</span>
  <span class="nc">String</span> <span class="n">invokeWith</span><span class="o">,</span> <span class="nc">String</span><span class="o">[]</span> <span class="n">zygoteArgs</span><span class="o">)</span> <span class="o">{</span>
  <span class="k">try</span> <span class="o">{</span>
      <span class="c1">// processClass = "android.app.ActivityThread"</span>
      <span class="c1">// zygoteArgs = null</span>
      <span class="c1">// 通过 zygote 启动进程</span>
      <span class="k">return</span> <span class="nf">startViaZygote</span><span class="o">(</span><span class="n">processClass</span><span class="o">,</span> <span class="n">niceName</span><span class="o">,</span> <span class="n">uid</span><span class="o">,</span> <span class="n">gid</span><span class="o">,</span> <span class="n">gids</span><span class="o">,</span>
              <span class="n">debugFlags</span><span class="o">,</span> <span class="n">mountExternal</span><span class="o">,</span> <span class="n">targetSdkVersion</span><span class="o">,</span> <span class="n">seInfo</span><span class="o">,</span>
              <span class="n">abi</span><span class="o">,</span> <span class="n">instructionSet</span><span class="o">,</span> <span class="n">appDataDir</span><span class="o">,</span> <span class="n">invokeWith</span><span class="o">,</span> <span class="n">zygoteArgs</span><span class="o">);</span>
  <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">ZygoteStartFailedEx</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span>
              <span class="s">"Starting VM process through Zygote failed"</span><span class="o">,</span> <span class="n">ex</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div></ul><h2 id="zygoteprocess">ZygoteProcess</h2><p><code class="language-plaintext highlighter-rouge">/frameworks/base/core/java/android/os/ZygoteProcess.java</code></p><ul><li>#start() -&gt; startViaZygote()<div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
</pre><td class="rouge-code"><pre><span class="kd">private</span> <span class="nc">Process</span><span class="o">.</span><span class="na">ProcessStartResult</span> <span class="nf">startViaZygote</span><span class="o">(</span><span class="kd">final</span> <span class="nc">String</span> <span class="n">processClass</span><span class="o">,</span>
  <span class="kd">final</span> <span class="nc">String</span> <span class="n">niceName</span><span class="o">,</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">uid</span><span class="o">,</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">gid</span><span class="o">,</span> <span class="kd">final</span> <span class="kt">int</span><span class="o">[]</span> <span class="n">gids</span><span class="o">,</span>
  <span class="kt">int</span> <span class="n">debugFlags</span><span class="o">,</span> <span class="kt">int</span> <span class="n">mountExternal</span><span class="o">,</span> <span class="kt">int</span> <span class="n">targetSdkVersion</span><span class="o">,</span> <span class="nc">String</span> <span class="n">seInfo</span><span class="o">,</span>
  <span class="nc">String</span> <span class="n">abi</span><span class="o">,</span> <span class="nc">String</span> <span class="n">instructionSet</span><span class="o">,</span> <span class="nc">String</span> <span class="n">appDataDir</span><span class="o">,</span> <span class="nc">String</span> <span class="n">invokeWith</span><span class="o">,</span>
  <span class="nc">String</span><span class="o">[]</span> <span class="n">extraArgs</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">ZygoteStartFailedEx</span> <span class="o">{</span>
  <span class="c1">// 存放启动参数，这里的参数将会在 ZygoteConnection 中被解析出来</span>
  <span class="nc">ArrayList</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">argsForZygote</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;();</span>
  <span class="c1">// 传一大波参数给 server</span>
  <span class="c1">// --runtime-args, --setuid=, --setgid=,</span>
  <span class="c1">// and --setgroups= must go first</span>
  <span class="n">argsForZygote</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"--runtime-args"</span><span class="o">);</span>
  <span class="n">argsForZygote</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"--setuid="</span> <span class="o">+</span> <span class="n">uid</span><span class="o">);</span>
  <span class="n">argsForZygote</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"--setgid="</span> <span class="o">+</span> <span class="n">gid</span><span class="o">);</span>
  <span class="k">if</span> <span class="o">((</span><span class="n">debugFlags</span> <span class="o">&amp;</span> <span class="nc">Zygote</span><span class="o">.</span><span class="na">DEBUG_ENABLE_JNI_LOGGING</span><span class="o">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">argsForZygote</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"--enable-jni-logging"</span><span class="o">);</span>
  <span class="o">}</span>
  <span class="k">if</span> <span class="o">((</span><span class="n">debugFlags</span> <span class="o">&amp;</span> <span class="nc">Zygote</span><span class="o">.</span><span class="na">DEBUG_ENABLE_SAFEMODE</span><span class="o">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">argsForZygote</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"--enable-safemode"</span><span class="o">);</span>
  <span class="o">}</span>
  <span class="k">if</span> <span class="o">((</span><span class="n">debugFlags</span> <span class="o">&amp;</span> <span class="nc">Zygote</span><span class="o">.</span><span class="na">DEBUG_ENABLE_JDWP</span><span class="o">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">argsForZygote</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"--enable-jdwp"</span><span class="o">);</span>
  <span class="o">}</span>
  <span class="k">if</span> <span class="o">((</span><span class="n">debugFlags</span> <span class="o">&amp;</span> <span class="nc">Zygote</span><span class="o">.</span><span class="na">DEBUG_ENABLE_CHECKJNI</span><span class="o">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">argsForZygote</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"--enable-checkjni"</span><span class="o">);</span>
  <span class="o">}</span>
  <span class="k">if</span> <span class="o">((</span><span class="n">debugFlags</span> <span class="o">&amp;</span> <span class="nc">Zygote</span><span class="o">.</span><span class="na">DEBUG_GENERATE_DEBUG_INFO</span><span class="o">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">argsForZygote</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"--generate-debug-info"</span><span class="o">);</span>
  <span class="o">}</span>
  <span class="k">if</span> <span class="o">((</span><span class="n">debugFlags</span> <span class="o">&amp;</span> <span class="nc">Zygote</span><span class="o">.</span><span class="na">DEBUG_ALWAYS_JIT</span><span class="o">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">argsForZygote</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"--always-jit"</span><span class="o">);</span>
  <span class="o">}</span>
  <span class="k">if</span> <span class="o">((</span><span class="n">debugFlags</span> <span class="o">&amp;</span> <span class="nc">Zygote</span><span class="o">.</span><span class="na">DEBUG_NATIVE_DEBUGGABLE</span><span class="o">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">argsForZygote</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"--native-debuggable"</span><span class="o">);</span>
  <span class="o">}</span>
  <span class="k">if</span> <span class="o">((</span><span class="n">debugFlags</span> <span class="o">&amp;</span> <span class="nc">Zygote</span><span class="o">.</span><span class="na">DEBUG_JAVA_DEBUGGABLE</span><span class="o">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">argsForZygote</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"--java-debuggable"</span><span class="o">);</span>
  <span class="o">}</span>
  <span class="k">if</span> <span class="o">((</span><span class="n">debugFlags</span> <span class="o">&amp;</span> <span class="nc">Zygote</span><span class="o">.</span><span class="na">DEBUG_ENABLE_ASSERT</span><span class="o">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">argsForZygote</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"--enable-assert"</span><span class="o">);</span>
  <span class="o">}</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">mountExternal</span> <span class="o">==</span> <span class="nc">Zygote</span><span class="o">.</span><span class="na">MOUNT_EXTERNAL_DEFAULT</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">argsForZygote</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"--mount-external-default"</span><span class="o">);</span>
  <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">mountExternal</span> <span class="o">==</span> <span class="nc">Zygote</span><span class="o">.</span><span class="na">MOUNT_EXTERNAL_READ</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">argsForZygote</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"--mount-external-read"</span><span class="o">);</span>
  <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">mountExternal</span> <span class="o">==</span> <span class="nc">Zygote</span><span class="o">.</span><span class="na">MOUNT_EXTERNAL_WRITE</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">argsForZygote</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"--mount-external-write"</span><span class="o">);</span>
  <span class="o">}</span>
  <span class="n">argsForZygote</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"--target-sdk-version="</span> <span class="o">+</span> <span class="n">targetSdkVersion</span><span class="o">);</span>

  <span class="c1">// --setgroups is a comma-separated list</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">gids</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">gids</span><span class="o">.</span><span class="na">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
      <span class="nc">StringBuilder</span> <span class="n">sb</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">StringBuilder</span><span class="o">();</span>
      <span class="n">sb</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">"--setgroups="</span><span class="o">);</span>

      <span class="kt">int</span> <span class="n">sz</span> <span class="o">=</span> <span class="n">gids</span><span class="o">.</span><span class="na">length</span><span class="o">;</span>
      <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">sz</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
          <span class="k">if</span> <span class="o">(</span><span class="n">i</span> <span class="o">!=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
              <span class="n">sb</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="sc">','</span><span class="o">);</span>
          <span class="o">}</span>
          <span class="n">sb</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">gids</span><span class="o">[</span><span class="n">i</span><span class="o">]);</span>
      <span class="o">}</span>
      <span class="n">argsForZygote</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">sb</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
  <span class="o">}</span>

  <span class="k">if</span> <span class="o">(</span><span class="n">niceName</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">argsForZygote</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"--nice-name="</span> <span class="o">+</span> <span class="n">niceName</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="k">if</span> <span class="o">(</span><span class="n">seInfo</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">argsForZygote</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"--seinfo="</span> <span class="o">+</span> <span class="n">seInfo</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="k">if</span> <span class="o">(</span><span class="n">instructionSet</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">argsForZygote</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"--instruction-set="</span> <span class="o">+</span> <span class="n">instructionSet</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="k">if</span> <span class="o">(</span><span class="n">appDataDir</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">argsForZygote</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"--app-data-dir="</span> <span class="o">+</span> <span class="n">appDataDir</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="k">if</span> <span class="o">(</span><span class="n">invokeWith</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">argsForZygote</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"--invoke-with"</span><span class="o">);</span>
      <span class="n">argsForZygote</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">invokeWith</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="n">argsForZygote</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">processClass</span><span class="o">);</span>

  <span class="c1">// 这个语句走不进去了，因为传过来的 extraArgs 参数为 null</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">extraArgs</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">for</span> <span class="o">(</span><span class="nc">String</span> <span class="n">arg</span> <span class="o">:</span> <span class="n">extraArgs</span><span class="o">)</span> <span class="o">{</span>
          <span class="n">argsForZygote</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">arg</span><span class="o">);</span>
      <span class="o">}</span>
  <span class="o">}</span>
  <span class="kd">synchronized</span><span class="o">(</span><span class="n">mLock</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">return</span> <span class="nf">zygoteSendArgsAndGetResult</span><span class="o">(</span><span class="n">openZygoteSocketIfNeeded</span><span class="o">(</span><span class="n">abi</span><span class="o">),</span> <span class="n">argsForZygote</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><li>#openZygoteSocketIfNeeded() 尝试打开一个 socket 与远程 server(ZygoteServer)进行通讯<li>#zygoteSendArgsAndGetResult() 得到 pid<div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
</pre><td class="rouge-code"><pre><span class="kd">private</span> <span class="kd">static</span> <span class="nc">Process</span><span class="o">.</span><span class="na">ProcessStartResult</span> <span class="nf">zygoteSendArgsAndGetResult</span><span class="o">(</span>
      <span class="nc">ZygoteState</span> <span class="n">zygoteState</span><span class="o">,</span> <span class="nc">ArrayList</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">ZygoteStartFailedEx</span> <span class="o">{</span>
  <span class="k">try</span> <span class="o">{</span>
      <span class="c1">// Throw early if any of the arguments are malformed. This means we can</span>
      <span class="c1">// avoid writing a partial response to the zygote.</span>
      <span class="c1">// ... 校验启动参数，如果不符合则抛出 ZygoteStartFailedEx 异常</span>

      <span class="cm">/*
       * 注意这里的注释，我当时就是跟到这里没法跟下去了，突然看到这里的注释，于是全局搜索了
       * 一把 'readArgumentList()' 才发现是在 ZygoteConnection 里调用了，
       * 正好在这个方法中有读取刚传过去参数的操作
       * See com.android.internal.os.SystemZygoteInit.readArgumentList()
       * Presently the wire format to the zygote process is:
       * a) a count of arguments (argc, in essence)
       * b) a number of newline-separated argument strings equal to count
       *
       * After the zygote process reads these it will write the pid of
       * the child or -1 on failure, followed by boolean to
       * indicate whether a wrapper process was used.
       */</span>
      <span class="kd">final</span> <span class="nc">BufferedWriter</span> <span class="n">writer</span> <span class="o">=</span> <span class="n">zygoteState</span><span class="o">.</span><span class="na">writer</span><span class="o">;</span>
      <span class="kd">final</span> <span class="nc">DataInputStream</span> <span class="n">inputStream</span> <span class="o">=</span> <span class="n">zygoteState</span><span class="o">.</span><span class="na">inputStream</span><span class="o">;</span>

      <span class="c1">// 首先写入参数的长度，接着逐行写入参数</span>
      <span class="c1">// 注意参数的写入顺序和读取顺序是一致的</span>
      <span class="n">writer</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="nc">Integer</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="n">args</span><span class="o">.</span><span class="na">size</span><span class="o">()));</span>
      <span class="n">writer</span><span class="o">.</span><span class="na">newLine</span><span class="o">();</span>
      <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">sz</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
          <span class="nc">String</span> <span class="n">arg</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
          <span class="n">writer</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">arg</span><span class="o">);</span>
          <span class="n">writer</span><span class="o">.</span><span class="na">newLine</span><span class="o">();</span>
      <span class="o">}</span>

      <span class="n">writer</span><span class="o">.</span><span class="na">flush</span><span class="o">();</span>

      <span class="c1">// Should there be a timeout on this?</span>
      <span class="nc">Process</span><span class="o">.</span><span class="na">ProcessStartResult</span> <span class="n">result</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Process</span><span class="o">.</span><span class="na">ProcessStartResult</span><span class="o">();</span>

      <span class="c1">// Always read the entire result from the input stream to avoid leaving</span>
      <span class="c1">// bytes in the stream for future process starts to accidentally stumble upon.</span>
      <span class="c1">// 读取 pid，还记得 AMS#startProcessLocked() 么，那里的 pid 就是这里得到的</span>
      <span class="n">result</span><span class="o">.</span><span class="na">pid</span> <span class="o">=</span> <span class="n">inputStream</span><span class="o">.</span><span class="na">readInt</span><span class="o">();</span>
      <span class="n">result</span><span class="o">.</span><span class="na">usingWrapper</span> <span class="o">=</span> <span class="n">inputStream</span><span class="o">.</span><span class="na">readBoolean</span><span class="o">();</span>

      <span class="k">if</span> <span class="o">(</span><span class="n">result</span><span class="o">.</span><span class="na">pid</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
          <span class="k">throw</span> <span class="k">new</span> <span class="nf">ZygoteStartFailedEx</span><span class="o">(</span><span class="s">"fork() failed"</span><span class="o">);</span>
      <span class="o">}</span>
      <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
  <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">zygoteState</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nf">ZygoteStartFailedEx</span><span class="o">(</span><span class="n">ex</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div></ul><h2 id="zygoteserver">ZygoteServer</h2><p><code class="language-plaintext highlighter-rouge">/frameworks/base/core/java/com/android/internal/os/ZygoteServer.java</code></p><ul><li>猜测：runSelectLoop() 方法是个死循环, ZygoteInit.main() 方法执行的时候就会开始循环， 当有新的 app 启动时就会调用这个方法，所以当我们调用 ZygoteProcess#openZygoteSocketIfNeeded() 方法的时候就会执行到这里来。<br /> 事实：此方法会抛出 Zygote.MethodAndArgsCaller 异常并且被 Zygote.main() 捕获, 在 catch 代码块里会调用 Zygote.MethodAndArgsCaller.run() 方法<li>runSelectLoop() 调用 ZygoteConnection#runOnce()<div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
</pre><td class="rouge-code"><pre><span class="kt">void</span> <span class="nf">runSelectLoop</span><span class="o">(</span><span class="nc">String</span> <span class="n">abiList</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Zygote</span><span class="o">.</span><span class="na">MethodAndArgsCaller</span> <span class="o">{</span>
  <span class="nc">ArrayList</span><span class="o">&lt;</span><span class="nc">FileDescriptor</span><span class="o">&gt;</span> <span class="n">fds</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;</span><span class="nc">FileDescriptor</span><span class="o">&gt;();</span>
  <span class="nc">ArrayList</span><span class="o">&lt;</span><span class="nc">ZygoteConnection</span><span class="o">&gt;</span> <span class="n">peers</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;</span><span class="nc">ZygoteConnection</span><span class="o">&gt;();</span>

  <span class="n">fds</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">mServerSocket</span><span class="o">.</span><span class="na">getFileDescriptor</span><span class="o">());</span>
  <span class="n">peers</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="kc">null</span><span class="o">);</span>

  <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
      <span class="nc">StructPollfd</span><span class="o">[]</span> <span class="n">pollFds</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">StructPollfd</span><span class="o">[</span><span class="n">fds</span><span class="o">.</span><span class="na">size</span><span class="o">()];</span>
      <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">pollFds</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="o">++</span><span class="n">i</span><span class="o">)</span> <span class="o">{</span>
          <span class="n">pollFds</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">StructPollfd</span><span class="o">();</span>
          <span class="n">pollFds</span><span class="o">[</span><span class="n">i</span><span class="o">].</span><span class="na">fd</span> <span class="o">=</span> <span class="n">fds</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
          <span class="n">pollFds</span><span class="o">[</span><span class="n">i</span><span class="o">].</span><span class="na">events</span> <span class="o">=</span> <span class="o">(</span><span class="kt">short</span><span class="o">)</span> <span class="no">POLLIN</span><span class="o">;</span>
      <span class="o">}</span>
      <span class="k">try</span> <span class="o">{</span>
          <span class="nc">Os</span><span class="o">.</span><span class="na">poll</span><span class="o">(</span><span class="n">pollFds</span><span class="o">,</span> <span class="o">-</span><span class="mi">1</span><span class="o">);</span>
      <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">ErrnoException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
          <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="s">"poll failed"</span><span class="o">,</span> <span class="n">ex</span><span class="o">);</span>
      <span class="o">}</span>
      <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">pollFds</span><span class="o">.</span><span class="na">length</span> <span class="o">-</span> <span class="mi">1</span><span class="o">;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="o">;</span> <span class="o">--</span><span class="n">i</span><span class="o">)</span> <span class="o">{</span>
          <span class="k">if</span> <span class="o">((</span><span class="n">pollFds</span><span class="o">[</span><span class="n">i</span><span class="o">].</span><span class="na">revents</span> <span class="o">&amp;</span> <span class="no">POLLIN</span><span class="o">)</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
              <span class="k">continue</span><span class="o">;</span>
          <span class="o">}</span>
          <span class="k">if</span> <span class="o">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
              <span class="c1">// 这里会创建一个新的 ZygoteConnection</span>
              <span class="nc">ZygoteConnection</span> <span class="n">newPeer</span> <span class="o">=</span> <span class="n">acceptCommandPeer</span><span class="o">(</span><span class="n">abiList</span><span class="o">);</span>
              <span class="n">peers</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">newPeer</span><span class="o">);</span>
              <span class="n">fds</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">newPeer</span><span class="o">.</span><span class="na">getFileDesciptor</span><span class="o">());</span>
          <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
              <span class="c1">// 逐步跟进代码会发现 Zygote.MethodAndArgsCaller 实际是由 </span>
              <span class="c1">// RuntimeInit.invokeStaticMain() 方法抛出的</span>
              <span class="kt">boolean</span> <span class="n">done</span> <span class="o">=</span> <span class="n">peers</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">i</span><span class="o">).</span><span class="na">runOnce</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
              <span class="k">if</span> <span class="o">(</span><span class="n">done</span><span class="o">)</span> <span class="o">{</span>
                  <span class="n">peers</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
                  <span class="n">fds</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
              <span class="o">}</span>
          <span class="o">}</span>
      <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div></ul><h2 id="zygoteconnection">ZygoteConnection</h2><p><code class="language-plaintext highlighter-rouge">/frameworks/base/core/java/com/android/internal/os/ZygoteConnection.java</code></p><ul><li>runOnce() 调用 readArgumentList() 方法， 读取完参数就把 socket 连接 close 掉了<ul><li>此方法会抛出 Zygote.MethodAndArgsCaller 异常，这个异常比较特殊 稍后再讲<li>预加载资源、预加载 package 等等<li>fork 子进程 pid = 0<li>handleChildProc() 抛出 Zygote.MethodAndArgsCaller<li>ZygoteInit.zygoteInit()<li>RuntimeInit.commonInit()<li>ZygoteInit.nativeZygoteInit()<li>RuntimeInit.applicationInit()<li>RuntimeInit.invokeStaticMain() 抛出 Zygote.MethodAndArgsCaller</ul><li>#runOnce()<div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
</pre><td class="rouge-code"><pre><span class="kt">boolean</span> <span class="nf">runOnce</span><span class="o">(</span><span class="nc">ZygoteServer</span> <span class="n">zygoteServer</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Zygote</span><span class="o">.</span><span class="na">MethodAndArgsCaller</span> <span class="o">{</span>

  <span class="nc">String</span> <span class="n">args</span><span class="o">[];</span>
  <span class="nc">Arguments</span> <span class="n">parsedArgs</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
  <span class="nc">FileDescriptor</span><span class="o">[]</span> <span class="n">descriptors</span><span class="o">;</span>
  <span class="k">try</span> <span class="o">{</span>
      <span class="c1">// 看！还记得这个方法么？上面我们提到过的</span>
      <span class="n">args</span> <span class="o">=</span> <span class="n">readArgumentList</span><span class="o">();</span>
      <span class="n">descriptors</span> <span class="o">=</span> <span class="n">mSocket</span><span class="o">.</span><span class="na">getAncillaryFileDescriptors</span><span class="o">();</span>
  <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">closeSocket</span><span class="o">();</span>
      <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
  <span class="o">}</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">args</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
      <span class="c1">// EOF reached. End of File: 到底文件末尾了</span>
      <span class="n">closeSocket</span><span class="o">();</span>
      <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
  <span class="o">}</span>
  <span class="c1">// ...</span>
  <span class="k">try</span> <span class="o">{</span>
      <span class="n">parsedArgs</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Arguments</span><span class="o">(</span><span class="n">args</span><span class="o">);</span>
      <span class="c1">// ... 根据参数做的一系列操作，略过</span>
      <span class="c1">// 这里就是 fork 子进程的了，如果成功 pid 将返回 0，pid &lt; 0 标志着失败</span>
      <span class="n">pid</span> <span class="o">=</span> <span class="nc">Zygote</span><span class="o">.</span><span class="na">forkAndSpecialize</span><span class="o">(</span><span class="n">parsedArgs</span><span class="o">.</span><span class="na">uid</span><span class="o">,</span> <span class="n">parsedArgs</span><span class="o">.</span><span class="na">gid</span><span class="o">,</span> <span class="n">parsedArgs</span><span class="o">.</span><span class="na">gids</span><span class="o">,</span>
              <span class="n">parsedArgs</span><span class="o">.</span><span class="na">debugFlags</span><span class="o">,</span> <span class="n">rlimits</span><span class="o">,</span> <span class="n">parsedArgs</span><span class="o">.</span><span class="na">mountExternal</span><span class="o">,</span> <span class="n">parsedArgs</span><span class="o">.</span><span class="na">seInfo</span><span class="o">,</span>
              <span class="n">parsedArgs</span><span class="o">.</span><span class="na">niceName</span><span class="o">,</span> <span class="n">fdsToClose</span><span class="o">,</span> <span class="n">fdsToIgnore</span><span class="o">,</span> <span class="n">parsedArgs</span><span class="o">.</span><span class="na">instructionSet</span><span class="o">,</span>
              <span class="n">parsedArgs</span><span class="o">.</span><span class="na">appDataDir</span><span class="o">);</span>
  <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">ErrnoException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">logAndPrintError</span><span class="o">(</span><span class="n">newStderr</span><span class="o">,</span> <span class="s">"Exception creating pipe"</span><span class="o">,</span> <span class="n">ex</span><span class="o">);</span>
  <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IllegalArgumentException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">logAndPrintError</span><span class="o">(</span><span class="n">newStderr</span><span class="o">,</span> <span class="s">"Invalid zygote arguments"</span><span class="o">,</span> <span class="n">ex</span><span class="o">);</span>
  <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">ZygoteSecurityException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">logAndPrintError</span><span class="o">(</span><span class="n">newStderr</span><span class="o">,</span>
              <span class="s">"Zygote security policy prevents request: "</span><span class="o">,</span> <span class="n">ex</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="k">try</span> <span class="o">{</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">pid</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
          <span class="c1">// in child，fork 子进程成功</span>
          <span class="n">zygoteServer</span><span class="o">.</span><span class="na">closeServerSocket</span><span class="o">();</span>
          <span class="nc">IoUtils</span><span class="o">.</span><span class="na">closeQuietly</span><span class="o">(</span><span class="n">serverPipeFd</span><span class="o">);</span>
          <span class="n">serverPipeFd</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
          <span class="c1">// 跳转到 handleChildProc()</span>
          <span class="n">handleChildProc</span><span class="o">(</span><span class="n">parsedArgs</span><span class="o">,</span> <span class="n">descriptors</span><span class="o">,</span> <span class="n">childPipeFd</span><span class="o">,</span> <span class="n">newStderr</span><span class="o">);</span>
          <span class="c1">// should never get here, the child is expected to either</span>
          <span class="c1">// throw Zygote.MethodAndArgsCaller or exec().</span>
          <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
      <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
          <span class="c1">// in parent...pid of &lt; 0 means failure</span>
          <span class="c1">// ...fork 失败，略过</span>
      <span class="o">}</span>
  <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
      <span class="nc">IoUtils</span><span class="o">.</span><span class="na">closeQuietly</span><span class="o">(</span><span class="n">childPipeFd</span><span class="o">);</span>
      <span class="nc">IoUtils</span><span class="o">.</span><span class="na">closeQuietly</span><span class="o">(</span><span class="n">serverPipeFd</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><li>#readArgList()<div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
</pre><td class="rouge-code"><pre><span class="kd">private</span> <span class="nc">String</span><span class="o">[]</span> <span class="nf">readArgumentList</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
  <span class="kt">int</span> <span class="n">argc</span><span class="o">;</span>
  <span class="k">try</span> <span class="o">{</span>
      <span class="nc">String</span> <span class="n">s</span> <span class="o">=</span> <span class="n">mSocketReader</span><span class="o">.</span><span class="na">readLine</span><span class="o">();</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">s</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
          <span class="c1">// EOF reached.</span>
          <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
      <span class="o">}</span>
      <span class="c1">// 第一步取出传过来的参数长度，用于后面创建数组时限定长度</span>
      <span class="n">argc</span> <span class="o">=</span> <span class="nc">Integer</span><span class="o">.</span><span class="na">parseInt</span><span class="o">(</span><span class="n">s</span><span class="o">);</span>
  <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">NumberFormatException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
      <span class="c1">// ...</span>
  <span class="o">}</span>
  <span class="c1">// 第二步利用上面读取出的参数长度创建数组</span>
  <span class="nc">String</span><span class="o">[]</span> <span class="n">result</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">String</span><span class="o">[</span><span class="n">argc</span><span class="o">];</span>
  <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">argc</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
      <span class="c1">// 第三步逐行读取并赋值</span>
      <span class="n">result</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="n">mSocketReader</span><span class="o">.</span><span class="na">readLine</span><span class="o">();</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">result</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
          <span class="c1">// We got an unexpected EOF.</span>
          <span class="k">throw</span> <span class="k">new</span> <span class="nf">IOException</span><span class="o">(</span><span class="s">"truncated request"</span><span class="o">);</span>
      <span class="o">}</span>
  <span class="o">}</span>
  <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
<span class="o">}</span>
</pre></table></code></div></div><li>#handleChildProc() ```java private void handleChildProc(Arguments parsedArgs, FileDescriptor[] descriptors, FileDescriptor pipeFd, PrintStream newStderr) throws Zygote.MethodAndArgsCaller { /*<ul><li>By the time we get here, the native code has closed the two actual Zygote<li>socket connections, and substituted /dev/null in their place. The LocalSocket<li>objects still need to be closed properly. <em>/ closeSocket(); if (descriptors != null) { // … 执行释放资源的操作，略过 } // 设置进程名 if (parsedArgs.niceName != null) { Process.setArgV0(parsedArgs.niceName); } // End of the postFork event. if (parsedArgs.invokeWith != null) { // … } else { // 跳转到 ZygoteInit 中 ZygoteInit.zygoteInit(parsedArgs.targetSdkVersion, parsedArgs.remainingArgs, null /</em> classLoader */); } } ```</ul></ul><h2 id="zygoteinit">ZygoteInit</h2><p><code class="language-plaintext highlighter-rouge">/frameworks/base/core/java/com/android/internal/os/ZygoteInit.java</code></p><ul><li>#zygoteInit()<div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">void</span> <span class="nf">zygoteInit</span><span class="o">(</span><span class="kt">int</span> <span class="n">targetSdkVersion</span><span class="o">,</span> <span class="nc">String</span><span class="o">[]</span> <span class="n">argv</span><span class="o">,</span>
      <span class="nc">ClassLoader</span> <span class="n">classLoader</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Zygote</span><span class="o">.</span><span class="na">MethodAndArgsCaller</span> <span class="o">{</span>
  <span class="c1">// 将 System.out/err 重定向到 Android 的 log 系统</span>
  <span class="nc">RuntimeInit</span><span class="o">.</span><span class="na">redirectLogStreams</span><span class="o">();</span>
  <span class="c1">// 初始化时区、语言、http user-agent 等</span>
  <span class="nc">RuntimeInit</span><span class="o">.</span><span class="na">commonInit</span><span class="o">();</span>
  <span class="c1">// 这是一个 native 方法</span>
  <span class="nc">ZygoteInit</span><span class="o">.</span><span class="na">nativeZygoteInit</span><span class="o">();</span>
  <span class="c1">// 跳转到 RuntimeInit#applicationInit() 马上就到 ActivityThread.main() 方法执行了</span>
  <span class="nc">RuntimeInit</span><span class="o">.</span><span class="na">applicationInit</span><span class="o">(</span><span class="n">targetSdkVersion</span><span class="o">,</span> <span class="n">argv</span><span class="o">,</span> <span class="n">classLoader</span><span class="o">);</span>
<span class="o">}</span>
</pre></table></code></div></div><li>#main() 调用 ZogyteServer.runSelectLoop() 方法<div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span> <span class="n">argv</span><span class="o">[])</span> <span class="o">{</span>
  <span class="nc">ZygoteServer</span> <span class="n">zygoteServer</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ZygoteServer</span><span class="o">();</span>
  <span class="k">try</span> <span class="o">{</span>
      <span class="c1">// ...</span>
      <span class="kt">boolean</span> <span class="n">startSystemServer</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
      <span class="c1">// zygote socket name</span>
      <span class="nc">String</span> <span class="n">socketName</span> <span class="o">=</span> <span class="s">"zygote"</span><span class="o">;</span>
      <span class="nc">String</span> <span class="n">abiList</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
      <span class="kt">boolean</span> <span class="n">enableLazyPreload</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
      <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">argv</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
          <span class="k">if</span> <span class="o">(</span><span class="s">"start-system-server"</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">argv</span><span class="o">[</span><span class="n">i</span><span class="o">]))</span> <span class="o">{</span>
              <span class="n">startSystemServer</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
          <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="s">"--enable-lazy-preload"</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">argv</span><span class="o">[</span><span class="n">i</span><span class="o">]))</span> <span class="o">{</span>
              <span class="n">enableLazyPreload</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
          <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">argv</span><span class="o">[</span><span class="n">i</span><span class="o">].</span><span class="na">startsWith</span><span class="o">(</span><span class="no">ABI_LIST_ARG</span><span class="o">))</span> <span class="o">{</span>
              <span class="n">abiList</span> <span class="o">=</span> <span class="n">argv</span><span class="o">[</span><span class="n">i</span><span class="o">].</span><span class="na">substring</span><span class="o">(</span><span class="no">ABI_LIST_ARG</span><span class="o">.</span><span class="na">length</span><span class="o">());</span>
          <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">argv</span><span class="o">[</span><span class="n">i</span><span class="o">].</span><span class="na">startsWith</span><span class="o">(</span><span class="no">SOCKET_NAME_ARG</span><span class="o">))</span> <span class="o">{</span>
              <span class="n">socketName</span> <span class="o">=</span> <span class="n">argv</span><span class="o">[</span><span class="n">i</span><span class="o">].</span><span class="na">substring</span><span class="o">(</span><span class="no">SOCKET_NAME_ARG</span><span class="o">.</span><span class="na">length</span><span class="o">());</span>
          <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
              <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="s">"Unknown command line argument: "</span> <span class="o">+</span> <span class="n">argv</span><span class="o">[</span><span class="n">i</span><span class="o">]);</span>
          <span class="o">}</span>
      <span class="o">}</span>
      <span class="c1">// ...</span>
      <span class="n">zygoteServer</span><span class="o">.</span><span class="na">registerServerSocket</span><span class="o">(</span><span class="n">socketName</span><span class="o">);</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">startSystemServer</span><span class="o">)</span> <span class="o">{</span>
          <span class="n">startSystemServer</span><span class="o">(</span><span class="n">abiList</span><span class="o">,</span> <span class="n">socketName</span><span class="o">,</span> <span class="n">zygoteServer</span><span class="o">);</span>
      <span class="o">}</span>
      <span class="c1">// 开启循环</span>
      <span class="n">zygoteServer</span><span class="o">.</span><span class="na">runSelectLoop</span><span class="o">(</span><span class="n">abiList</span><span class="o">);</span>
      <span class="n">zygoteServer</span><span class="o">.</span><span class="na">closeServerSocket</span><span class="o">();</span>
  <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Zygote</span><span class="o">.</span><span class="na">MethodAndArgsCaller</span> <span class="n">caller</span><span class="o">)</span> <span class="o">{</span>
      <span class="c1">// 执行 run() 方法，通过反射调用 ActivityThread.main()</span>
      <span class="n">caller</span><span class="o">.</span><span class="na">run</span><span class="o">();</span>
  <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Throwable</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
      <span class="nc">Log</span><span class="o">.</span><span class="na">e</span><span class="o">(</span><span class="no">TAG</span><span class="o">,</span> <span class="s">"System zygote died with exception"</span><span class="o">,</span> <span class="n">ex</span><span class="o">);</span>
      <span class="n">zygoteServer</span><span class="o">.</span><span class="na">closeServerSocket</span><span class="o">();</span>
      <span class="k">throw</span> <span class="n">ex</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div></ul><h2 id="runtimeinit">RuntimeInit</h2><p><code class="language-plaintext highlighter-rouge">/frameworks/base/core/java/com/android/internal/os/RuntimeInit.java</code></p><ul><li>#applicationInit()<div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre><td class="rouge-code"><pre><span class="kd">protected</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">applicationInit</span><span class="o">(</span><span class="kt">int</span> <span class="n">targetSdkVersion</span><span class="o">,</span> <span class="nc">String</span><span class="o">[]</span> <span class="n">argv</span><span class="o">,</span> 
  <span class="nc">ClassLoader</span> <span class="n">classLoader</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Zygote</span><span class="o">.</span><span class="na">MethodAndArgsCaller</span> <span class="o">{</span>
  <span class="c1">// We want to be fairly aggressive about heap utilization, to avoid</span>
  <span class="c1">// holding on to a lot of memory that isn't needed.</span>
  <span class="nc">VMRuntime</span><span class="o">.</span><span class="na">getRuntime</span><span class="o">().</span><span class="na">setTargetHeapUtilization</span><span class="o">(</span><span class="mf">0.75f</span><span class="o">);</span>
  <span class="nc">VMRuntime</span><span class="o">.</span><span class="na">getRuntime</span><span class="o">().</span><span class="na">setTargetSdkVersion</span><span class="o">(</span><span class="n">targetSdkVersion</span><span class="o">);</span>
  <span class="kd">final</span> <span class="nc">Arguments</span> <span class="n">args</span><span class="o">;</span>
  <span class="k">try</span> <span class="o">{</span>
      <span class="c1">// 解析参数</span>
      <span class="n">args</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Arguments</span><span class="o">(</span><span class="n">argv</span><span class="o">);</span>
  <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IllegalArgumentException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
      <span class="c1">// let the process exit</span>
      <span class="k">return</span><span class="o">;</span>
  <span class="o">}</span>
  <span class="c1">// Remaining arguments are passed to the start class's static main</span>
  <span class="c1">// 还记得我们前面提到过的 processClass = "android.app.ActivityThread" 么</span>
  <span class="c1">// 这里的 args.startClass 就是了， 千呼万唤始出来来啊！ 跳转！！！</span>
  <span class="n">invokeStaticMain</span><span class="o">(</span><span class="n">args</span><span class="o">.</span><span class="na">startClass</span><span class="o">,</span> <span class="n">args</span><span class="o">.</span><span class="na">startArgs</span><span class="o">,</span> <span class="n">classLoader</span><span class="o">);</span>
<span class="o">}</span>
</pre></table></code></div></div><li>#invokeStaticMain()<div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
</pre><td class="rouge-code"><pre><span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">invokeStaticMain</span><span class="o">(</span><span class="nc">String</span> <span class="n">className</span><span class="o">,</span> <span class="nc">String</span><span class="o">[]</span> <span class="n">argv</span><span class="o">,</span> <span class="nc">ClassLoader</span> <span class="n">classLoader</span><span class="o">)</span>
      <span class="kd">throws</span> <span class="nc">Zygote</span><span class="o">.</span><span class="na">MethodAndArgsCaller</span> <span class="o">{</span>
  <span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">cl</span><span class="o">;</span>
  <span class="k">try</span> <span class="o">{</span>
      <span class="c1">// 通过反射拿到 ActivityThread class</span>
      <span class="n">cl</span> <span class="o">=</span> <span class="nc">Class</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="n">className</span><span class="o">,</span> <span class="kc">true</span><span class="o">,</span> <span class="n">classLoader</span><span class="o">);</span>
  <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">ClassNotFoundException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
      <span class="c1">// ...</span>
  <span class="o">}</span>
  <span class="nc">Method</span> <span class="n">m</span><span class="o">;</span>
  <span class="k">try</span> <span class="o">{</span>
      <span class="c1">// 通过反射获取 main() 方法</span>
      <span class="n">m</span> <span class="o">=</span> <span class="n">cl</span><span class="o">.</span><span class="na">getMethod</span><span class="o">(</span><span class="s">"main"</span><span class="o">,</span> <span class="k">new</span> <span class="nc">Class</span><span class="o">[]</span> <span class="o">{</span> <span class="nc">String</span><span class="o">[].</span><span class="na">class</span> <span class="o">});</span>
  <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">NoSuchMethodException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
      <span class="c1">// ...</span>
  <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">SecurityException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
      <span class="c1">// ...</span>
  <span class="o">}</span>
  <span class="c1">// ... 校验方法修饰符，略过</span>

  <span class="cm">/* 注释写的很清楚啊，此异常会被 ZygoteInit.main() 方法捕获并执行 run() 方法
   * This throw gets caught in ZygoteInit.main(), which responds
   * by invoking the exception's run() method. This arrangement
   * clears up all the stack frames that were required in setting
   * up the process.
   */</span>
  <span class="c1">// 这里传入的 m 就是 ActivityThread 的 main() 方法，我们再来看 </span>
  <span class="c1">// Zygote.MethodAndArgsCaller.run() 做了什么</span>
  <span class="k">throw</span> <span class="k">new</span> <span class="nc">Zygote</span><span class="o">.</span><span class="na">MethodAndArgsCaller</span><span class="o">(</span><span class="n">m</span><span class="o">,</span> <span class="n">argv</span><span class="o">);</span>
<span class="o">}</span>
</pre></table></code></div></div></ul><h2 id="zygonte">Zygonte</h2><p><code class="language-plaintext highlighter-rouge">/frameworks/base/core/java/com/android/internal/os/Zygote.java</code></p><ul><li>Zygonte.MethodAndArgsCaller 继承 Exception 并实现了 Runnable 接口<div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">MethodAndArgsCaller</span> <span class="kd">extends</span> <span class="nc">Exception</span> <span class="kd">implements</span> <span class="nc">Runnable</span> <span class="o">{</span>
  <span class="cm">/** method to call */</span>
  <span class="kd">private</span> <span class="kd">final</span> <span class="nc">Method</span> <span class="n">mMethod</span><span class="o">;</span>
  <span class="cm">/** argument array */</span>
  <span class="kd">private</span> <span class="kd">final</span> <span class="nc">String</span><span class="o">[]</span> <span class="n">mArgs</span><span class="o">;</span>

  <span class="kd">public</span> <span class="nf">MethodAndArgsCaller</span><span class="o">(</span><span class="nc">Method</span> <span class="n">method</span><span class="o">,</span> <span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">mMethod</span> <span class="o">=</span> <span class="n">method</span><span class="o">;</span>
      <span class="n">mArgs</span> <span class="o">=</span> <span class="n">args</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="nd">@override</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
      <span class="k">try</span> <span class="o">{</span>
          <span class="c1">// 啊~ 简单粗暴，直接通过反射调用 ActivityThread.main() 方法</span>
          <span class="n">mMethod</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="kc">null</span><span class="o">,</span> <span class="k">new</span> <span class="nc">Object</span><span class="o">[]</span> <span class="o">{</span> <span class="n">mArgs</span> <span class="o">});</span>
      <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IllegalAccessException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
          <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="n">ex</span><span class="o">);</span>
      <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InvocationTargetException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
          <span class="c1">// ...</span>
      <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div></ul><h2 id="总结">总结</h2><ul><li>源码阅读的过程实在是太痛苦了，有时候跟着跟着就不知跳到哪里去了，所以呢最好找一篇前辈写好的 文章放一旁，等自己迷路的时候，看一下航标。<li>过程虽然痛苦，但是成功之后的喜悦只有自己才明白，O(∩_∩)O哈哈哈哈~<li>总是看别人的博客，学习别人的心得，自己却很少有知识输出，从今之后要疯狂输出了，不足之处 还请各位大佬指出，一定改正！</ul><h2 id="结语">结语</h2><blockquote><p>此次源码分析到这里就结束了，各位看官欲知后事如何，且听下回分解。</p></blockquote><h2 id="参考资料">参考资料</h2><ul><li><a href="https://www.cnblogs.com/mzsoft/p/4460156.html">[高级]Android Launcher研究(二)Launcher为何物，究竟是干什么的？</a><li><a href="https://dev-xu.cn/posts/b3e682b8.html">Android 7.0 startActivity()源码解析以及对几个问题的思考</a><li><a href="https://github.com/echoma/text_sequence_diagram">画图工具</a><li><a href="https://baike.baidu.com/item/EOF/1017800?fr=aladdin">什么是EOF</a></ul></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/android/'>android</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/framework/" class="post-tag no-text-decoration" >framework</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=01-app启动流程分析 - sleticalboy&url=http://localhost:4001/posts/01-app%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=01-app启动流程分析 - sleticalboy&u=http://localhost:4001/posts/01-app%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=01-app启动流程分析 - sleticalboy&url=http://localhost:4001/posts/01-app%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/Daily-Question-Record/">Daily Question Record</a><li><a href="/posts/%E9%9D%A2%E8%AF%95%E6%80%BB%E7%BB%93/">面试总结</a><li><a href="/posts/at-provider-lifecycle/">at-provider-lifecycle</a><li><a href="/posts/03-AndroidManifest%E6%96%87%E4%BB%B6%E8%A7%A3%E6%9E%90/">03-AndroidManifest文件解析</a><li><a href="/posts/at-activity-lifecycle/">at-activity-lifecycle</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/framework/">framework</a> <a class="post-tag" href="/tags/linux/">linux</a> <a class="post-tag" href="/tags/android/">android</a> <a class="post-tag" href="/tags/english-learning/">english learning</a> <a class="post-tag" href="/tags/open-source/">open source</a> <a class="post-tag" href="/tags/components/">components</a> <a class="post-tag" href="/tags/daily-life/">daily life</a> <a class="post-tag" href="/tags/aosp/">aosp</a> <a class="post-tag" href="/tags/git/">git</a> <a class="post-tag" href="/tags/practice/">practice</a></div></div></div><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/anr/"><div class="card-body"> <span class="timeago small" > Dec 2 <i class="unloaded">2020-12-02T10:19:11+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>anr</h3><div class="text-muted small"><p> anr 原理</p></div></div></a></div><div class="card"> <a href="/posts/at-provider-lifecycle/"><div class="card-body"> <span class="timeago small" > Dec 2 <i class="unloaded">2020-12-02T10:19:11+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>at-provider-lifecycle</h3><div class="text-muted small"><p> ActivityThread 中 Provider 生命周期 bindApplication() bindApplication() -&gt; mH.sendMessage(H.BIND_APPLICATION) -&gt; handleBindApplication() handleBindApplication() 设置 AsyncTask 执行任务的线程池 1 2 ...</p></div></div></a></div><div class="card"> <a href="/posts/binder-settings-anr/"><div class="card-body"> <span class="timeago small" > Dec 2 <i class="unloaded">2020-12-02T10:19:11+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>binder-settings-anr</h3><div class="text-muted small"><p> Binder Settings anr 引起的思考 1 2 3 4 5 6 7 8 9 10 11 12 13 native: #02 pc 000000000005a844 /system/lib64/libbinder.so (android::IPCThreadState::talkWithDriver(bool)+260) native: #03 pc 000000000005b7...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/wms/" class="btn btn-outline-primary"><p>wms</p></a> <a href="/posts/02-app%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90/" class="btn btn-outline-primary"><p>02-app启动流程分析</p></a></div></div></div></div><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lozad/dist/lozad.min.js"></script> <script type="text/javascript"> const imgs = document.querySelectorAll('#post-wrapper img'); const observer = lozad(imgs); observer.observe(); </script><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2020 <a href="https://twitter.com/username">BenLee</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy/" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-xl-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/framework/">framework</a> <a class="post-tag" href="/tags/linux/">linux</a> <a class="post-tag" href="/tags/android/">android</a> <a class="post-tag" href="/tags/english-learning/">english learning</a> <a class="post-tag" href="/tags/open-source/">open source</a> <a class="post-tag" href="/tags/components/">components</a> <a class="post-tag" href="/tags/daily-life/">daily life</a> <a class="post-tag" href="/tags/aosp/">aosp</a> <a class="post-tag" href="/tags/git/">git</a> <a class="post-tag" href="/tags/practice/">practice</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="http://localhost:4001{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"><div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>{categories}</div><div><i class="fa fa-tag fa-fw"></i>{tags}</div></div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>' }); </script>
