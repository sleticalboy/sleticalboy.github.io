<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="theme" content="Chirpy v2.6.2"><meta name="generator" content="Jekyll v4.1.1" /><meta property="og:title" content="Android binder 架构： java 层" /><meta name="author" content="sleticalboy" /><meta property="og:locale" content="en_US" /><meta name="description" content="涉及到的源码及路径：" /><meta property="og:description" content="涉及到的源码及路径：" /><link rel="canonical" href="https://sleticalboy.github.io/android/2021/01/08/android-binder-architecture-2/" /><meta property="og:url" content="https://sleticalboy.github.io/android/2021/01/08/android-binder-architecture-2/" /><meta property="og:site_name" content="sleticalboy" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2021-01-08T13:09:34+08:00" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"dateModified":"2021-03-06T23:12:46+08:00","datePublished":"2021-01-08T13:09:34+08:00","@type":"BlogPosting","headline":"Android binder 架构： java 层","mainEntityOfPage":{"@type":"WebPage","@id":"https://sleticalboy.github.io/android/2021/01/08/android-binder-architecture-2/"},"author":{"@type":"Person","name":"sleticalboy"},"description":"涉及到的源码及路径：","url":"https://sleticalboy.github.io/android/2021/01/08/android-binder-architecture-2/","@context":"https://schema.org"}</script><title>Android binder 架构： java 层 | sleticalboy</title><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon.png"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon-precomposed.png"><link rel="apple-touch-icon" sizes="57x57" href="/assets/img/favicons/apple-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/assets/img/favicons/apple-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/assets/img/favicons/apple-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/assets/img/favicons/apple-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/assets/img/favicons/apple-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/assets/img/favicons/apple-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/assets/img/favicons/apple-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/assets/img/favicons/apple-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-icon-180x180.png"><link rel="icon" type="image/png" sizes="192x192" href="/assets/img/favicons/android-icon-192x192.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="/assets/img/favicons/favicon-96x96.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/manifest.json"><meta name='msapplication-config' content='/assets/img/favicons/browserconfig.xml'><meta name="msapplication-TileColor" content="#ffffff"><meta name="msapplication-TileImage" content="/assets/img/favicons/ms-icon-144x144.png"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="cdn.jsdelivr.net"><link rel="dns-prefetch" href="cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha256-LA89z+k9fjgMKQ/kq4OO2Mrf8VltYml/VES+Rg0fh20=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css" integrity="sha256-+N4/V/SbAFiW1MPBCXnfnP9QSN3+Keu+NlB+0ev/YKQ=" crossorigin="anonymous"><link rel="preload" as="style" href="/assets/css/post.css"><link rel="stylesheet" href="/assets/css/post.css"><link rel="preload" as="style" href="/assets/css/lib/bootstrap-toc.min.css"><link rel="stylesheet" href="/assets/css/lib/bootstrap-toc.min.css" /> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script async src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script async src="/assets/js/post.min.js"></script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column"><div id="nav-wrapper"><div id="profile-wrapper" class="d-flex flex-column"><div id="avatar" class="d-flex justify-content-center"> <a href="/" alt="avatar"> <img src="/assets/img/sample/avatar.jpg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="profile-text mt-3"><div class="site-title"> <a href="/">sleticalboy</a></div><div class="site-subtitle font-italic">李斌的小站</div></div></div><ul class="nav flex-column"><li class="nav-item d-flex justify-content-center "> <a href="/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item d-flex justify-content-center "> <a href="/tabs/categories/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item d-flex justify-content-center "> <a href="/tabs/tags/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item d-flex justify-content-center "> <a href="/tabs/archives/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item d-flex justify-content-center "> <a href="/tabs/about/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul></div><div class="sidebar-bottom d-flex flex-wrap justify-content-around mt-4"> <span id="mode-toggle-wrapper"> <i class="mode-toggle fas fa-sun" dark-mode-invisible></i> <i class="mode-toggle fas fa-moon" light-mode-invisible></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.mode != null) { if (this.mode == ModeToggle.DARK_MODE) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.mode != null) { if (self.mode == ModeToggle.DARK_MODE) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span> <span class="icon-border"></span> <a href="https://github.com/sleticalboy" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['sleticalboy','gmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Posts </a> </span> <span>Android binder 架构： java 层</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Android binder 架构： java 层</h1><div class="post-meta text-muted d-flex flex-column"><div> Posted <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Fri, Jan 8, 2021, 1:09 PM +0800" > Jan 8 <i class="unloaded">2021-01-08T13:09:34+08:00</i> </span> by <span class="author"> sleticalboy </span></div><div> Updated <span class="timeago lastmod" data-toggle="tooltip" data-placement="bottom" title="Sat, Mar 6, 2021, 11:12 PM +0800" > Mar 6 <i class="unloaded">2021-03-06T23:12:46+08:00</i> </span></div></div><div class="post-content"><p>涉及到的源码及路径：</p><p><code class="language-plaintext highlighter-rouge">frameworks/base/core/java/android/os/IBinder.java</code><br /> <code class="language-plaintext highlighter-rouge">frameworks/base/core/java/android/os/Binder.java</code><br /> <code class="language-plaintext highlighter-rouge">frameworks/base/core/java/android/os/IInterface.java</code><br /> <code class="language-plaintext highlighter-rouge">frameworks/base/core/java/com/android/internal/os/BinderInternal.java</code><br /> <code class="language-plaintext highlighter-rouge">frameworks/base/services/java/com/android/server/SystemServer.java</code><br /> <code class="language-plaintext highlighter-rouge">frameworks/base/services/core/java/com/android/server/am/ActivityManagerService.java</code><br /> <code class="language-plaintext highlighter-rouge">frameworks/base/services/core/java/com/android/server/SystemServiceManager.java</code><br /> <code class="language-plaintext highlighter-rouge">frameworks/base/core/java/android/os/IServiceManager.java</code><br /> <code class="language-plaintext highlighter-rouge">frameworks/base/core/java/android/os/ServiceManager.java</code><br /> <code class="language-plaintext highlighter-rouge">frameworks/base/core/java/android/os/ServiceManagerNative.java</code><br /> <code class="language-plaintext highlighter-rouge">frameworks/base/core/jni/android_util_Binder.cpp</code><br /> <code class="language-plaintext highlighter-rouge">frameworks/base/core/jni/android_os_Parcel.cpp</code><br /> <code class="language-plaintext highlighter-rouge">frameworks/base/core/jni/AndroidRuntime.cpp</code></p><h2 id="java-层-binder-架构">Java 层 Binder 架构</h2><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 " data-src="/assets/android/binder-java-arch.png" alt="java binder arch" /></p><ul><li>系统定义了一个 IBinder 接口和其内部的 DeathRecipient 接口<li>Binder 和 BinderProxy 分别实现了 IBinder 接口；Binder 作为服务端 Bn 的代表，而 BinderProxy 则作为服务端 Bp 的代表<li>BinderInternal 类是仅供 Binder 架构使用的‘特供类’，其内部有一个 GcWatcher 类， 专门用于处理和 Binder 架构相关的垃圾回收工作<li>Parcel 类用于承载数据通信的职责<li>总体来看，Java 层 Binder 和 native 层 Binder 是很相似的，可以看做是 native 层 的一个镜像</ul><p><strong>理解 FLAG_ONEWAY 标记：</strong><br /></p><ul><li>此标记位用于 transact 方法：单方面调用，意味着调用者在调用之后立即返回，不需要 等待被调用方返回结果，仅用于调用者和被调用者处于不同的进程时<li>native 层中的 Binder 调用基本都是阻塞调用<li>Java 层可以使用此标记位实现‘非阻塞’调用，如果没有此标记位则是‘阻塞’调用， 会一直等待直到被调用方返回结果<li>Java 层使用此标记位时一般都会给被调用方（server）注册一个回调，通过该回调告知 调用方（client）该请求的处理结果</ul><h2 id="java-层-binder-初始化">Java 层 Binder 初始化</h2><p>Java 层 Binder 的需要借助 native 层 Binder 才能展开工作，因此一定要在 Java 层 Binder 正式开始工作之前建立与 native 层 Binder 的关系。在 Android 系统中，Java 世界初始化时期（<code class="language-plaintext highlighter-rouge">AndroidRuntime.cpp::start()</code>），系统会提前注册一些 JNI 函数， 其中 <code class="language-plaintext highlighter-rouge">android_util_Binder.cpp::register_android_os_Binder()</code> 专门用来负责建立起 该联系：</p><div class="language-cpp highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
</pre><td class="rouge-code"><pre><span class="kt">int</span> <span class="nf">register_android_os_Binder</span><span class="p">(</span><span class="n">JNIEnv</span><span class="o">*</span> <span class="n">env</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// 1、建立 Java Binder 和 native 层的关系</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">int_register_android_os_Binder</span><span class="p">(</span><span class="n">env</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="c1">// 2、建立 Java BinderInternal 和 native 层的关系</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">int_register_android_os_BinderInternal</span><span class="p">(</span><span class="n">env</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="c1">// 3、建立 Java BinderProxy 和 native 层的关系</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">int_register_android_os_BinderProxy</span><span class="p">(</span><span class="n">env</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="c1">// Log#e() 函数</span>
    <span class="n">jclass</span> <span class="n">clazz</span> <span class="o">=</span> <span class="n">FindClassOrDie</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="s">"android/util/Log"</span><span class="p">);</span>
    <span class="n">gLogOffsets</span><span class="p">.</span><span class="n">mClass</span> <span class="o">=</span> <span class="n">MakeGlobalRefOrDie</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">clazz</span><span class="p">);</span>
    <span class="n">gLogOffsets</span><span class="p">.</span><span class="n">mLogE</span> <span class="o">=</span> <span class="n">GetStaticMethodIDOrDie</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">clazz</span><span class="p">,</span> <span class="s">"e"</span><span class="p">,</span>
            <span class="s">"(Ljava/lang/String;Ljava/lang/String;Ljava/lang/Throwable;)I"</span><span class="p">);</span>
    <span class="c1">// PercelFileDescriptor#&lt;init&gt; 函数</span>
    <span class="n">clazz</span> <span class="o">=</span> <span class="n">FindClassOrDie</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="s">"android/os/ParcelFileDescriptor"</span><span class="p">);</span>
    <span class="n">gParcelFileDescriptorOffsets</span><span class="p">.</span><span class="n">mClass</span> <span class="o">=</span> <span class="n">MakeGlobalRefOrDie</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">clazz</span><span class="p">);</span>
    <span class="n">gParcelFileDescriptorOffsets</span><span class="p">.</span><span class="n">mConstructor</span> <span class="o">=</span> 
        <span class="n">GetMethodIDOrDie</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">clazz</span><span class="p">,</span> <span class="s">"&lt;init&gt;"</span><span class="p">,</span> <span class="s">"(Ljava/io/FileDescriptor;)V"</span><span class="p">);</span>
    <span class="c1">// StrictMode#onBinderStrictModePolicyChange() 函数</span>
    <span class="n">clazz</span> <span class="o">=</span> <span class="n">FindClassOrDie</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="s">"android/os/StrictMode"</span><span class="p">);</span>
    <span class="n">gStrictModeCallbackOffsets</span><span class="p">.</span><span class="n">mClass</span> <span class="o">=</span> <span class="n">MakeGlobalRefOrDie</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">clazz</span><span class="p">);</span>
    <span class="n">gStrictModeCallbackOffsets</span><span class="p">.</span><span class="n">mCallback</span> <span class="o">=</span> <span class="n">GetStaticMethodIDOrDie</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">clazz</span><span class="p">,</span>
            <span class="s">"onBinderStrictModePolicyChange"</span><span class="p">,</span> <span class="s">"(I)V"</span><span class="p">);</span>
    <span class="c1">// Thread#dispatchUncaughtException() 函数</span>
    <span class="n">clazz</span> <span class="o">=</span> <span class="n">FindClassOrDie</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="s">"java/lang/Thread"</span><span class="p">);</span>
    <span class="n">gThreadDispatchOffsets</span><span class="p">.</span><span class="n">mClass</span> <span class="o">=</span> <span class="n">MakeGlobalRefOrDie</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">clazz</span><span class="p">);</span>
    <span class="n">gThreadDispatchOffsets</span><span class="p">.</span><span class="n">mDispatchUncaughtException</span> <span class="o">=</span> <span class="n">GetMethodIDOrDie</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">clazz</span><span class="p">,</span>
            <span class="s">"dispatchUncaughtException"</span><span class="p">,</span> <span class="s">"(Ljava/lang/Throwable;)V"</span><span class="p">);</span>
    <span class="c1">// Thread#currentThread() 函数</span>
    <span class="n">gThreadDispatchOffsets</span><span class="p">.</span><span class="n">mCurrentThread</span> <span class="o">=</span> <span class="n">GetStaticMethodIDOrDie</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">clazz</span><span class="p">,</span>
            <span class="s">"currentThread"</span><span class="p">,</span> <span class="s">"()Ljava/lang/Thread;"</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><h3 id="建立-java-binder-和-native-层的关系">建立 Java Binder 和 native 层的关系</h3><div class="language-cpp highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
</pre><td class="rouge-code"><pre><span class="c1">// 用于存放 Java 层 Binder 类在 native 层中使用到的信息</span>
<span class="k">static</span> <span class="k">struct</span> <span class="nc">bindernative_offsets_t</span> <span class="p">{</span>
    <span class="n">jclass</span> <span class="n">mClass</span><span class="p">;</span> <span class="c1">// android.os.Binder class</span>
    <span class="n">jmethodID</span> <span class="n">mExecTransact</span><span class="p">;</span> <span class="c1">// execTransact() method</span>
    <span class="n">jfieldID</span> <span class="n">mObject</span><span class="p">;</span> <span class="c1">// Object state.</span>
<span class="p">}</span> <span class="n">gBinderOffsets</span><span class="p">;</span>
<span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="k">const</span> <span class="n">kBinderPathName</span> <span class="o">=</span> <span class="s">"android/os/Binder"</span><span class="p">;</span>
<span class="c1">// Java Binder 类中的 native 函数</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">JNINativeMethod</span> <span class="n">gBinderMethods</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
     <span class="cm">/* name, signature, funcPtr */</span>
    <span class="p">{</span> <span class="s">"getCallingPid"</span><span class="p">,</span> <span class="s">"()I"</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">android_os_Binder_getCallingPid</span> <span class="p">},</span>
    <span class="p">{</span> <span class="s">"getCallingUid"</span><span class="p">,</span> <span class="s">"()I"</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">android_os_Binder_getCallingUid</span> <span class="p">},</span>
    <span class="p">{</span> <span class="s">"clearCallingIdentity"</span><span class="p">,</span> <span class="s">"()J"</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">android_os_Binder_clearCallingIdentity</span> <span class="p">},</span>
    <span class="p">{</span> <span class="s">"restoreCallingIdentity"</span><span class="p">,</span> <span class="s">"(J)V"</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">android_os_Binder_restoreCallingIdentity</span> <span class="p">},</span>
    <span class="p">{</span> <span class="s">"setThreadStrictModePolicy"</span><span class="p">,</span> <span class="s">"(I)V"</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">android_os_Binder_setThreadStrictModePolicy</span> <span class="p">},</span>
    <span class="p">{</span> <span class="s">"getThreadStrictModePolicy"</span><span class="p">,</span> <span class="s">"()I"</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">android_os_Binder_getThreadStrictModePolicy</span> <span class="p">},</span>
    <span class="p">{</span> <span class="s">"flushPendingCommands"</span><span class="p">,</span> <span class="s">"()V"</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">android_os_Binder_flushPendingCommands</span> <span class="p">},</span>
    <span class="p">{</span> <span class="s">"getNativeBBinderHolder"</span><span class="p">,</span> <span class="s">"()J"</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">android_os_Binder_getNativeBBinderHolder</span> <span class="p">},</span>
    <span class="p">{</span> <span class="s">"getNativeFinalizer"</span><span class="p">,</span> <span class="s">"()J"</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">android_os_Binder_getNativeFinalizer</span> <span class="p">},</span>
    <span class="p">{</span> <span class="s">"blockUntilThreadAvailable"</span><span class="p">,</span> <span class="s">"()V"</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">android_os_Binder_blockUntilThreadAvailable</span> <span class="p">}</span>
<span class="p">};</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">int_register_android_os_Binder</span><span class="p">(</span><span class="n">JNIEnv</span><span class="o">*</span> <span class="n">env</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// 找到 android.os.Binder 类</span>
    <span class="n">jclass</span> <span class="n">clazz</span> <span class="o">=</span> <span class="n">FindClassOrDie</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">kBinderPathName</span><span class="p">);</span>
    <span class="n">gBinderOffsets</span><span class="p">.</span><span class="n">mClass</span> <span class="o">=</span> <span class="n">MakeGlobalRefOrDie</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">clazz</span><span class="p">);</span>
    <span class="c1">// Binder#execTransact() 方法</span>
    <span class="n">gBinderOffsets</span><span class="p">.</span><span class="n">mExecTransact</span> <span class="o">=</span> <span class="n">GetMethodIDOrDie</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">clazz</span><span class="p">,</span> <span class="s">"execTransact"</span><span class="p">,</span> <span class="s">"(IJJI)Z"</span><span class="p">);</span>
    <span class="c1">// Binder#mObject 字段</span>
    <span class="n">gBinderOffsets</span><span class="p">.</span><span class="n">mObject</span> <span class="o">=</span> <span class="n">GetFieldIDOrDie</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">clazz</span><span class="p">,</span> <span class="s">"mObject"</span><span class="p">,</span> <span class="s">"J"</span><span class="p">);</span>
    <span class="c1">// 注册 Binder 类中 native 函数的实现</span>
    <span class="k">return</span> <span class="n">RegisterMethodsOrDie</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">kBinderPathName</span><span class="p">,</span> <span class="n">gBinderMethods</span><span class="p">,</span>
        <span class="n">NELEM</span><span class="p">(</span><span class="n">gBinderMethods</span><span class="p">));</span>
<span class="p">}</span>
</pre></table></code></div></div><h3 id="建立-java-binderinternal-和-native-层的关系">建立 Java BinderInternal 和 native 层的关系</h3><div class="language-cpp highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
</pre><td class="rouge-code"><pre><span class="c1">// Java BinderInternal 中的 native 函数</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">JNINativeMethod</span> <span class="n">gBinderInternalMethods</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
     <span class="cm">/* name, signature, funcPtr */</span>
    <span class="p">{</span> <span class="s">"getContextObject"</span><span class="p">,</span> <span class="s">"()Landroid/os/IBinder;"</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">android_os_BinderInternal_getContextObject</span> <span class="p">},</span>
    <span class="p">{</span> <span class="s">"joinThreadPool"</span><span class="p">,</span> <span class="s">"()V"</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">android_os_BinderInternal_joinThreadPool</span> <span class="p">},</span>
    <span class="p">{</span> <span class="s">"disableBackgroundScheduling"</span><span class="p">,</span> <span class="s">"(Z)V"</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">android_os_BinderInternal_disableBackgroundScheduling</span> <span class="p">},</span>
    <span class="p">{</span> <span class="s">"setMaxThreads"</span><span class="p">,</span> <span class="s">"(I)V"</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">android_os_BinderInternal_setMaxThreads</span> <span class="p">},</span>
    <span class="p">{</span> <span class="s">"handleGc"</span><span class="p">,</span> <span class="s">"()V"</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">android_os_BinderInternal_handleGc</span> <span class="p">},</span>
    <span class="p">{</span> <span class="s">"nSetBinderProxyCountEnabled"</span><span class="p">,</span> <span class="s">"(Z)V"</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">android_os_BinderInternal_setBinderProxyCountEnabled</span> <span class="p">},</span>
    <span class="p">{</span> <span class="s">"nGetBinderProxyPerUidCounts"</span><span class="p">,</span> <span class="s">"()Landroid/util/SparseIntArray;"</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">android_os_BinderInternal_getBinderProxyPerUidCounts</span> <span class="p">},</span>
    <span class="p">{</span> <span class="s">"nGetBinderProxyCount"</span><span class="p">,</span> <span class="s">"(I)I"</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">android_os_BinderInternal_getBinderProxyCount</span> <span class="p">},</span>
    <span class="p">{</span> <span class="s">"nSetBinderProxyCountWatermarks"</span><span class="p">,</span> <span class="s">"(II)V"</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">android_os_BinderInternal_setBinderProxyCountWatermarks</span><span class="p">}</span>
<span class="p">};</span>
<span class="c1">// 用于存放 Java 层 BinderInternal 类在 native 层中使用到的信息</span>
<span class="k">static</span> <span class="k">struct</span> <span class="nc">binderinternal_offsets_t</span> <span class="p">{</span>
    <span class="n">jclass</span> <span class="n">mClass</span><span class="p">;</span> <span class="c1">// com.android.internal.os.BinderInternal class</span>
    <span class="n">jmethodID</span> <span class="n">mForceGc</span><span class="p">;</span> <span class="c1">// forceBinderGc() method</span>
    <span class="n">jmethodID</span> <span class="n">mProxyLimitCallback</span><span class="p">;</span> <span class="c1">// binderProxyLimitCallbackFromNative() method</span>
<span class="p">}</span> <span class="n">gBinderInternalOffsets</span><span class="p">;</span>
<span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="k">const</span> <span class="n">kBinderInternalPathName</span> <span class="o">=</span> <span class="s">"com/android/internal/os/BinderInternal"</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">int_register_android_os_BinderInternal</span><span class="p">(</span><span class="n">JNIEnv</span><span class="o">*</span> <span class="n">env</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// 找到 com.android.internal.os.BinderInteral 类</span>
    <span class="n">jclass</span> <span class="n">clazz</span> <span class="o">=</span> <span class="n">FindClassOrDie</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">kBinderInternalPathName</span><span class="p">);</span>
    <span class="n">gBinderInternalOffsets</span><span class="p">.</span><span class="n">mClass</span> <span class="o">=</span> <span class="n">MakeGlobalRefOrDie</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">clazz</span><span class="p">);</span>
    <span class="c1">// BinderInternal#forceBinderGc() 方法</span>
    <span class="n">gBinderInternalOffsets</span><span class="p">.</span><span class="n">mForceGc</span> <span class="o">=</span> <span class="n">GetStaticMethodIDOrDie</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">clazz</span><span class="p">,</span>
        <span class="s">"forceBinderGc"</span><span class="p">,</span> <span class="s">"()V"</span><span class="p">);</span>
    <span class="c1">// BinderInternal#binderProxyLimitCallbackFromNative() 方法</span>
    <span class="n">gBinderInternalOffsets</span><span class="p">.</span><span class="n">mProxyLimitCallback</span> <span class="o">=</span> <span class="n">GetStaticMethodIDOrDie</span><span class="p">(</span><span class="n">env</span><span class="p">,</span>
        <span class="n">clazz</span><span class="p">,</span> <span class="s">"binderProxyLimitCallbackFromNative"</span><span class="p">,</span> <span class="s">"(I)V"</span><span class="p">);</span>
    <span class="c1">// 注册回调</span>
    <span class="n">BpBinder</span><span class="o">::</span><span class="n">setLimitCallback</span><span class="p">(</span><span class="n">android_os_BinderInternal_proxyLimitcallback</span><span class="p">);</span>
    <span class="c1">// 注册 BinderInternal 中的 native 方法</span>
    <span class="k">return</span> <span class="n">RegisterMethodsOrDie</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">kBinderInternalPathName</span><span class="p">,</span>
        <span class="n">gBinderInternalMethods</span><span class="p">,</span> <span class="n">NELEM</span><span class="p">(</span><span class="n">gBinderInternalMethods</span><span class="p">));</span>
<span class="p">}</span>
</pre></table></code></div></div><h3 id="建立-java-binderproxy-和-native-层的关系">建立 Java BinderProxy 和 native 层的关系</h3><div class="language-cpp highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
</pre><td class="rouge-code"><pre><span class="c1">// Java BinderProxy 中的 native 方法 </span>
<span class="k">static</span> <span class="k">const</span> <span class="n">JNINativeMethod</span> <span class="n">gBinderProxyMethods</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
     <span class="cm">/* name, signature, funcPtr */</span>
    <span class="p">{</span><span class="s">"pingBinder"</span><span class="p">,</span>          <span class="s">"()Z"</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">android_os_BinderProxy_pingBinder</span><span class="p">},</span>
    <span class="p">{</span><span class="s">"isBinderAlive"</span><span class="p">,</span>       <span class="s">"()Z"</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">android_os_BinderProxy_isBinderAlive</span><span class="p">},</span>
    <span class="p">{</span><span class="s">"getInterfaceDescriptor"</span><span class="p">,</span> <span class="s">"()Ljava/lang/String;"</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">android_os_BinderProxy_getInterfaceDescriptor</span><span class="p">},</span>
    <span class="p">{</span><span class="s">"transactNative"</span><span class="p">,</span>      <span class="s">"(ILandroid/os/Parcel;Landroid/os/Parcel;I)Z"</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">android_os_BinderProxy_transact</span><span class="p">},</span>
    <span class="p">{</span><span class="s">"linkToDeath"</span><span class="p">,</span>         <span class="s">"(Landroid/os/IBinder$DeathRecipient;I)V"</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">android_os_BinderProxy_linkToDeath</span><span class="p">},</span>
    <span class="p">{</span><span class="s">"unlinkToDeath"</span><span class="p">,</span>       <span class="s">"(Landroid/os/IBinder$DeathRecipient;I)Z"</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">android_os_BinderProxy_unlinkToDeath</span><span class="p">},</span>
    <span class="p">{</span><span class="s">"getNativeFinalizer"</span><span class="p">,</span>  <span class="s">"()J"</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">android_os_BinderProxy_getNativeFinalizer</span><span class="p">},</span>
<span class="p">};</span>
<span class="c1">// 用于存放 Java 层 BinderProxy 类在 native 层中使用到的信息</span>
<span class="k">static</span> <span class="k">struct</span> <span class="nc">binderproxy_offsets_t</span> <span class="p">{</span>
    <span class="n">jclass</span> <span class="n">mClass</span><span class="p">;</span> <span class="c1">// android.os.BinderProxy class</span>
    <span class="n">jmethodID</span> <span class="n">mGetInstance</span><span class="p">;</span> <span class="c1">// getInstance() method</span>
    <span class="n">jmethodID</span> <span class="n">mSendDeathNotice</span><span class="p">;</span> <span class="c1">// sendDeathNotice() method</span>
    <span class="n">jmethodID</span> <span class="n">mDumpProxyDebugInfo</span><span class="p">;</span> <span class="c1">// dumpProxyDebugInfo() method</span>
    <span class="c1">// BinderProxy#mNativeData 字段，指向 native 层 BinderProxyNativeData 的指针</span>
    <span class="n">jfieldID</span> <span class="n">mNativeData</span><span class="p">;</span>
<span class="p">}</span> <span class="n">gBinderProxyOffsets</span><span class="p">;</span>
<span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="k">const</span> <span class="n">kBinderProxyPathName</span> <span class="o">=</span> <span class="s">"android/os/BinderProxy"</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">int_register_android_os_BinderProxy</span><span class="p">(</span><span class="n">JNIEnv</span><span class="o">*</span> <span class="n">env</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// 找到 android.os.BinderProxy 类</span>
    <span class="n">clazz</span> <span class="o">=</span> <span class="n">FindClassOrDie</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">kBinderProxyPathName</span><span class="p">);</span>
    <span class="n">gBinderProxyOffsets</span><span class="p">.</span><span class="n">mClass</span> <span class="o">=</span> <span class="n">MakeGlobalRefOrDie</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">clazz</span><span class="p">);</span>
    <span class="c1">// BinderProxy#getInstance() 静态方法</span>
    <span class="n">gBinderProxyOffsets</span><span class="p">.</span><span class="n">mGetInstance</span> <span class="o">=</span> <span class="n">GetStaticMethodIDOrDie</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">clazz</span><span class="p">,</span>
        <span class="s">"getInstance"</span><span class="p">,</span> <span class="s">"(JJ)Landroid/os/BinderProxy;"</span><span class="p">);</span>
    <span class="c1">// BinderProxy#sendDeathNotice() 静态方法</span>
    <span class="n">gBinderProxyOffsets</span><span class="p">.</span><span class="n">mSendDeathNotice</span> <span class="o">=</span> <span class="n">GetStaticMethodIDOrDie</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">clazz</span><span class="p">,</span>
        <span class="s">"sendDeathNotice"</span><span class="p">,</span> <span class="s">"(Landroid/os/IBinder$DeathRecipient;)V"</span><span class="p">);</span>
    <span class="c1">// BinderProxy#dumpProxyDebugInfo() 静态方法</span>
    <span class="n">gBinderProxyOffsets</span><span class="p">.</span><span class="n">mDumpProxyDebugInfo</span> <span class="o">=</span> <span class="n">GetStaticMethodIDOrDie</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">clazz</span><span class="p">,</span>
        <span class="s">"dumpProxyDebugInfo"</span><span class="p">,</span> <span class="s">"()V"</span><span class="p">);</span>
    <span class="c1">// BinderProxy#mNativeData 字段</span>
    <span class="n">gBinderProxyOffsets</span><span class="p">.</span><span class="n">mNativeData</span> <span class="o">=</span> <span class="n">GetFieldIDOrDie</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">clazz</span><span class="p">,</span> <span class="s">"mNativeData"</span><span class="p">,</span> <span class="s">"J"</span><span class="p">);</span>
    <span class="c1">// 注册 BinderProxy 中的静态方法</span>
    <span class="k">return</span> <span class="n">RegisterMethodsOrDie</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">kBinderProxyPathName</span><span class="p">,</span> <span class="n">gBinderProxyMethods</span><span class="p">,</span>
        <span class="n">NELEM</span><span class="p">(</span><span class="n">gBinderProxyMethods</span><span class="p">));</span>
<span class="p">}</span>
</pre></table></code></div></div><h3 id="建立-java-parcel-和-native-层的关系">建立 Java Parcel 和 native 层的关系</h3><p><code class="language-plaintext highlighter-rouge">android_os_Parcel.cpp::register_android_os_Parcel()</code></p><div class="language-cpp highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
</pre><td class="rouge-code"><pre><span class="c1">// 用于存放 Java 层 Parcel 类在 native 层中使用到的信息</span>
<span class="k">static</span> <span class="k">struct</span> <span class="nc">parcel_offsets_t</span> <span class="p">{</span>
    <span class="n">jclass</span> <span class="n">clazz</span><span class="p">;</span> <span class="c1">// android.os.Parcel class</span>
    <span class="n">jfieldID</span> <span class="n">mNativePtr</span><span class="p">;</span> <span class="c1">// mNativePre field</span>
    <span class="n">jmethodID</span> <span class="n">obtain</span><span class="p">;</span> <span class="c1">// obtain() method</span>
    <span class="n">jmethodID</span> <span class="n">recycle</span><span class="p">;</span> <span class="c1">// recycle() method</span>
<span class="p">}</span> <span class="n">gParcelOffsets</span><span class="p">;</span>
<span class="c1">// Java Parcel 中的 native 方法</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">JNINativeMethod</span> <span class="n">gParcelMethods</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="c1">// @CriticalNative</span>
    <span class="p">{</span><span class="s">"nativeDataSize"</span><span class="p">,</span>            <span class="s">"(J)I"</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">android_os_Parcel_dataSize</span><span class="p">},</span>
    <span class="c1">// @CriticalNative</span>
    <span class="p">{</span><span class="s">"nativeDataAvail"</span><span class="p">,</span>           <span class="s">"(J)I"</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">android_os_Parcel_dataAvail</span><span class="p">},</span>
    <span class="c1">// @CriticalNative</span>
    <span class="p">{</span><span class="s">"nativeDataPosition"</span><span class="p">,</span>        <span class="s">"(J)I"</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">android_os_Parcel_dataPosition</span><span class="p">},</span>
    <span class="c1">// @CriticalNative</span>
    <span class="p">{</span><span class="s">"nativeDataCapacity"</span><span class="p">,</span>        <span class="s">"(J)I"</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">android_os_Parcel_dataCapacity</span><span class="p">},</span>
    <span class="c1">// @FastNative</span>
    <span class="p">{</span><span class="s">"nativeSetDataSize"</span><span class="p">,</span>         <span class="s">"(JI)J"</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">android_os_Parcel_setDataSize</span><span class="p">},</span>
    <span class="c1">// @CriticalNative</span>
    <span class="p">{</span><span class="s">"nativeSetDataPosition"</span><span class="p">,</span>     <span class="s">"(JI)V"</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">android_os_Parcel_setDataPosition</span><span class="p">},</span>
    <span class="c1">// @FastNative</span>
    <span class="p">{</span><span class="s">"nativeSetDataCapacity"</span><span class="p">,</span>     <span class="s">"(JI)V"</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">android_os_Parcel_setDataCapacity</span><span class="p">},</span>

    <span class="c1">// @CriticalNative</span>
    <span class="p">{</span><span class="s">"nativePushAllowFds"</span><span class="p">,</span>        <span class="s">"(JZ)Z"</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">android_os_Parcel_pushAllowFds</span><span class="p">},</span>
    <span class="c1">// @CriticalNative</span>
    <span class="p">{</span><span class="s">"nativeRestoreAllowFds"</span><span class="p">,</span>     <span class="s">"(JZ)V"</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">android_os_Parcel_restoreAllowFds</span><span class="p">},</span>

    <span class="p">{</span><span class="s">"nativeWriteByteArray"</span><span class="p">,</span>      <span class="s">"(J[BII)V"</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">android_os_Parcel_writeByteArray</span><span class="p">},</span>
    <span class="p">{</span><span class="s">"nativeWriteBlob"</span><span class="p">,</span>           <span class="s">"(J[BII)V"</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">android_os_Parcel_writeBlob</span><span class="p">},</span>
    <span class="c1">// @FastNative</span>
    <span class="p">{</span><span class="s">"nativeWriteInt"</span><span class="p">,</span>            <span class="s">"(JI)V"</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">android_os_Parcel_writeInt</span><span class="p">},</span>
    <span class="c1">// @FastNative</span>
    <span class="p">{</span><span class="s">"nativeWriteLong"</span><span class="p">,</span>           <span class="s">"(JJ)V"</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">android_os_Parcel_writeLong</span><span class="p">},</span>
    <span class="c1">// @FastNative</span>
    <span class="p">{</span><span class="s">"nativeWriteFloat"</span><span class="p">,</span>          <span class="s">"(JF)V"</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">android_os_Parcel_writeFloat</span><span class="p">},</span>
    <span class="c1">// @FastNative</span>
    <span class="p">{</span><span class="s">"nativeWriteDouble"</span><span class="p">,</span>         <span class="s">"(JD)V"</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">android_os_Parcel_writeDouble</span><span class="p">},</span>
    <span class="p">{</span><span class="s">"nativeWriteString"</span><span class="p">,</span>         <span class="s">"(JLjava/lang/String;)V"</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">android_os_Parcel_writeString</span><span class="p">},</span>
    <span class="p">{</span><span class="s">"nativeWriteStrongBinder"</span><span class="p">,</span>   <span class="s">"(JLandroid/os/IBinder;)V"</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">android_os_Parcel_writeStrongBinder</span><span class="p">},</span>
    <span class="p">{</span><span class="s">"nativeWriteFileDescriptor"</span><span class="p">,</span> <span class="s">"(JLjava/io/FileDescriptor;)J"</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">android_os_Parcel_writeFileDescriptor</span><span class="p">},</span>

    <span class="p">{</span><span class="s">"nativeCreateByteArray"</span><span class="p">,</span>     <span class="s">"(J)[B"</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">android_os_Parcel_createByteArray</span><span class="p">},</span>
    <span class="p">{</span><span class="s">"nativeReadByteArray"</span><span class="p">,</span>       <span class="s">"(J[BI)Z"</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">android_os_Parcel_readByteArray</span><span class="p">},</span>
    <span class="p">{</span><span class="s">"nativeReadBlob"</span><span class="p">,</span>            <span class="s">"(J)[B"</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">android_os_Parcel_readBlob</span><span class="p">},</span>
    <span class="c1">// @CriticalNative</span>
    <span class="p">{</span><span class="s">"nativeReadInt"</span><span class="p">,</span>             <span class="s">"(J)I"</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">android_os_Parcel_readInt</span><span class="p">},</span>
    <span class="c1">// @CriticalNative</span>
    <span class="p">{</span><span class="s">"nativeReadLong"</span><span class="p">,</span>            <span class="s">"(J)J"</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">android_os_Parcel_readLong</span><span class="p">},</span>
    <span class="c1">// @CriticalNative</span>
    <span class="p">{</span><span class="s">"nativeReadFloat"</span><span class="p">,</span>           <span class="s">"(J)F"</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">android_os_Parcel_readFloat</span><span class="p">},</span>
    <span class="c1">// @CriticalNative</span>
    <span class="p">{</span><span class="s">"nativeReadDouble"</span><span class="p">,</span>          <span class="s">"(J)D"</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">android_os_Parcel_readDouble</span><span class="p">},</span>
    <span class="p">{</span><span class="s">"nativeReadString"</span><span class="p">,</span>          <span class="s">"(J)Ljava/lang/String;"</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">android_os_Parcel_readString</span><span class="p">},</span>
    <span class="p">{</span><span class="s">"nativeReadStrongBinder"</span><span class="p">,</span>    <span class="s">"(J)Landroid/os/IBinder;"</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">android_os_Parcel_readStrongBinder</span><span class="p">},</span>
    <span class="p">{</span><span class="s">"nativeReadFileDescriptor"</span><span class="p">,</span>  <span class="s">"(J)Ljava/io/FileDescriptor;"</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">android_os_Parcel_readFileDescriptor</span><span class="p">},</span>

    <span class="p">{</span><span class="s">"openFileDescriptor"</span><span class="p">,</span>        <span class="s">"(Ljava/lang/String;I)Ljava/io/FileDescriptor;"</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">android_os_Parcel_openFileDescriptor</span><span class="p">},</span>
    <span class="p">{</span><span class="s">"dupFileDescriptor"</span><span class="p">,</span>         <span class="s">"(Ljava/io/FileDescriptor;)Ljava/io/FileDescriptor;"</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">android_os_Parcel_dupFileDescriptor</span><span class="p">},</span>
    <span class="p">{</span><span class="s">"closeFileDescriptor"</span><span class="p">,</span>       <span class="s">"(Ljava/io/FileDescriptor;)V"</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">android_os_Parcel_closeFileDescriptor</span><span class="p">},</span>

    <span class="p">{</span><span class="s">"nativeCreate"</span><span class="p">,</span>              <span class="s">"()J"</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">android_os_Parcel_create</span><span class="p">},</span>
    <span class="p">{</span><span class="s">"nativeFreeBuffer"</span><span class="p">,</span>          <span class="s">"(J)J"</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">android_os_Parcel_freeBuffer</span><span class="p">},</span>
    <span class="p">{</span><span class="s">"nativeDestroy"</span><span class="p">,</span>             <span class="s">"(J)V"</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">android_os_Parcel_destroy</span><span class="p">},</span>

    <span class="p">{</span><span class="s">"nativeMarshall"</span><span class="p">,</span>            <span class="s">"(J)[B"</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">android_os_Parcel_marshall</span><span class="p">},</span>
    <span class="p">{</span><span class="s">"nativeUnmarshall"</span><span class="p">,</span>          <span class="s">"(J[BII)J"</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">android_os_Parcel_unmarshall</span><span class="p">},</span>
    <span class="p">{</span><span class="s">"nativeCompareData"</span><span class="p">,</span>         <span class="s">"(JJ)I"</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">android_os_Parcel_compareData</span><span class="p">},</span>
    <span class="p">{</span><span class="s">"nativeAppendFrom"</span><span class="p">,</span>          <span class="s">"(JJII)J"</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">android_os_Parcel_appendFrom</span><span class="p">},</span>
    <span class="c1">// @CriticalNative</span>
    <span class="p">{</span><span class="s">"nativeHasFileDescriptors"</span><span class="p">,</span>  <span class="s">"(J)Z"</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">android_os_Parcel_hasFileDescriptors</span><span class="p">},</span>
    <span class="p">{</span><span class="s">"nativeWriteInterfaceToken"</span><span class="p">,</span> <span class="s">"(JLjava/lang/String;)V"</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">android_os_Parcel_writeInterfaceToken</span><span class="p">},</span>
    <span class="p">{</span><span class="s">"nativeEnforceInterface"</span><span class="p">,</span>    <span class="s">"(JLjava/lang/String;)V"</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">android_os_Parcel_enforceInterface</span><span class="p">},</span>

    <span class="p">{</span><span class="s">"getGlobalAllocSize"</span><span class="p">,</span>        <span class="s">"()J"</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">android_os_Parcel_getGlobalAllocSize</span><span class="p">},</span>
    <span class="p">{</span><span class="s">"getGlobalAllocCount"</span><span class="p">,</span>       <span class="s">"()J"</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">android_os_Parcel_getGlobalAllocCount</span><span class="p">},</span>

    <span class="c1">// @CriticalNative</span>
    <span class="p">{</span><span class="s">"nativeGetBlobAshmemSize"</span><span class="p">,</span>       <span class="s">"(J)J"</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">android_os_Parcel_getBlobAshmemSize</span><span class="p">},</span>
<span class="p">};</span>
<span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="k">const</span> <span class="n">kParcelPathName</span> <span class="o">=</span> <span class="s">"android/os/Parcel"</span><span class="p">;</span>
<span class="kt">int</span> <span class="nf">register_android_os_Parcel</span><span class="p">(</span><span class="n">JNIEnv</span><span class="o">*</span> <span class="n">env</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// 找到 android.os.Percel 类</span>
    <span class="n">jclass</span> <span class="n">clazz</span> <span class="o">=</span> <span class="n">FindClassOrDie</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">kParcelPathName</span><span class="p">);</span>
    <span class="n">gParcelOffsets</span><span class="p">.</span><span class="n">clazz</span> <span class="o">=</span> <span class="n">MakeGlobalRefOrDie</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">clazz</span><span class="p">);</span>
    <span class="c1">// 获取 Percel#mNativePtr 字段</span>
    <span class="n">gParcelOffsets</span><span class="p">.</span><span class="n">mNativePtr</span> <span class="o">=</span> <span class="n">GetFieldIDOrDie</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">clazz</span><span class="p">,</span> <span class="s">"mNativePtr"</span><span class="p">,</span> <span class="s">"J"</span><span class="p">);</span>
    <span class="c1">// 获取 Percel#obtain() 静态方法</span>
    <span class="n">gParcelOffsets</span><span class="p">.</span><span class="n">obtain</span> <span class="o">=</span> <span class="n">GetStaticMethodIDOrDie</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">clazz</span><span class="p">,</span> <span class="s">"obtain"</span><span class="p">,</span> <span class="s">"()Landroid/os/Parcel;"</span><span class="p">);</span>
    <span class="c1">// 获取 Percel#recycle() 方法</span>
    <span class="n">gParcelOffsets</span><span class="p">.</span><span class="n">recycle</span> <span class="o">=</span> <span class="n">GetMethodIDOrDie</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">clazz</span><span class="p">,</span> <span class="s">"recycle"</span><span class="p">,</span> <span class="s">"()V"</span><span class="p">);</span>
    <span class="c1">// 注册 Parcel 类中的 native 方法</span>
    <span class="k">return</span> <span class="n">RegisterMethodsOrDie</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">kParcelPathName</span><span class="p">,</span> <span class="n">gParcelMethods</span><span class="p">,</span> <span class="n">NELEM</span><span class="p">(</span><span class="n">gParcelMethods</span><span class="p">));</span>
<span class="p">}</span>
</pre></table></code></div></div><h3 id="小结">小结</h3><ul><li>以上过成都是类似的，包括以下两方面内容：<ul><li>获取 Java 类中一些有用的 methodId 和 fieldId 存储起来，这说明 JNI 层会向上调 用到 Java 层中的函数或字段<li>注册 Java 类中 native 函数的实现</ul><li>框架的初始化其实就是提前获取一些 JNI 层使用的信息，比如类的成员函数/字段 id 等，这么做的好处是提前获取，等使用的时候就节省掉了 Binder 频繁调用时的查找时间</ul><h2 id="servicemanageraddservice-方法源码分析">ServiceManager#addService 方法源码分析</h2><p>以 <code class="language-plaintext highlighter-rouge">ActivityManagerService(AMS)</code> 如何将自身添加到 <code class="language-plaintext highlighter-rouge">ServiceManager(SM)</code> 为例来分析<br /></p><p><strong>代码调用流程如下</strong>：</p><pre>
SystemServer#main() -&gt; run() -&gt; startBootstrapService() -&gt;
a, AMS#&lt;init&gt; // AMS 初始化 mActivityManagerService
b, AMS#setSystemProcess() -&gt; // 从这里开始分析
SM#addService("activity", mActivityManagerService) 
...
</pre><p>大致分为两个步骤来分析：</p><ul><li>AMS 如何将自身添加到 SM 中<li>AMS 如何响应客户端的 Binder 请求</ul><h3 id="ams-将自己添加到-sm-中">AMS 将自己添加到 SM 中</h3><p>1、<code class="language-plaintext highlighter-rouge">AMS#setSystemProcess()</code></p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kt">void</span> <span class="nf">setSystemProcess</span><span class="o">()</span> <span class="o">{</span>
    <span class="c1">// 将 AMS 注册到 SM 中，服务名为 activity</span>
    <span class="nc">ServiceManager</span><span class="o">.</span><span class="na">addService</span><span class="o">(</span><span class="nc">Context</span><span class="o">.</span><span class="na">ACTIVITY_SERVICE</span><span class="o">,</span> <span class="k">this</span><span class="o">,</span> <span class="cm">/* allowIsolated= */</span> <span class="kc">true</span><span class="o">,</span>
        <span class="no">DUMP_FLAG_PRIORITY_CRITICAL</span> <span class="o">|</span> <span class="no">DUMP_FLAG_PRIORITY_NORMAL</span> <span class="o">|</span> <span class="no">DUMP_FLAG_PROTO</span><span class="o">);</span>
    <span class="c1">// ...</span>
<span class="o">}</span>
</pre></table></code></div></div><p>2、<code class="language-plaintext highlighter-rouge">SM#addService() &amp; SM#getIServiceManager()</code></p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">addService</span><span class="o">(</span><span class="nc">String</span> <span class="n">name</span><span class="o">,</span> <span class="nc">IBinder</span> <span class="n">service</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">allowIsolated</span><span class="o">,</span>
        <span class="kt">int</span> <span class="n">dumpPriority</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// 获取到 IServiceManager 并将服务注册到其中，其实就是将服务注册到 native</span>
    <span class="c1">// 层的 ServiceManager 中</span>
    <span class="n">getIServiceManager</span><span class="o">().</span><span class="na">addService</span><span class="o">(</span><span class="n">name</span><span class="o">,</span> <span class="n">service</span><span class="o">,</span> <span class="n">allowIsolated</span><span class="o">,</span> <span class="n">dumpPriority</span><span class="o">);</span>
<span class="o">}</span>

<span class="kd">private</span> <span class="kd">static</span> <span class="nc">IServiceManager</span> <span class="nf">getIServiceManager</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">sServiceManager</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">sServiceManager</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="c1">// 接下来分析 BinderInternal.getContextObject() 函数</span>
    <span class="n">sServiceManager</span> <span class="o">=</span> <span class="nc">ServiceManagerNative</span><span class="o">.</span><span class="na">asInterface</span><span class="o">(</span><span class="cm">/*IBinder*/</span>
        <span class="nc">Binder</span><span class="o">.</span><span class="na">allowBlocking</span><span class="o">(</span><span class="nc">BinderInternal</span><span class="o">.</span><span class="na">getContextObject</span><span class="o">()));</span>
    <span class="c1">// 这里的 asInterface() 方法与 native 层的 interface_cast 宏有异曲同工之处</span>
    <span class="c1">// 第 4 小节进行分析</span>
    <span class="k">return</span> <span class="n">sServiceManager</span><span class="o">;</span>
<span class="o">}</span>
</pre></table></code></div></div><p>3、<code class="language-plaintext highlighter-rouge">BinderInternal#getContextObject()</code></p><p>3.1、BinderInternal#getContextObject() 是一个 native 函数，其实现为 <code class="language-plaintext highlighter-rouge">android_os_util_Binder.cpp::android_os_BinderInternal_getContextObject()</code></p><div class="language-cpp highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="k">static</span> <span class="n">jobject</span> <span class="nf">android_os_BinderInternal_getContextObject</span><span class="p">(</span><span class="n">JNIEnv</span><span class="o">*</span> <span class="n">env</span><span class="p">,</span> <span class="n">jobject</span> <span class="n">clazz</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// 获取 native 层 ServiceManager 代理对象 BpServiceManager</span>
    <span class="n">sp</span><span class="o">&lt;</span><span class="n">IBinder</span><span class="o">&gt;</span> <span class="n">b</span> <span class="o">=</span> <span class="n">ProcessState</span><span class="o">::</span><span class="n">self</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getContextObject</span><span class="p">(</span><span class="nb">NULL</span><span class="cm">/*0*/</span><span class="p">);</span>
    <span class="c1">// 这里继续调用 javaObjectForIBinder() 函数利用 native 层 ServiceManager 的</span>
    <span class="c1">// 代理对象来创建一个 Java 层的 ServiceManager 代理对象</span>
    <span class="k">return</span> <span class="n">javaObjectForIBinder</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">b</span><span class="cm">/*BpBinder*/</span><span class="p">);</span>
<span class="p">}</span>
</pre></table></code></div></div><p>3.2、<code class="language-plaintext highlighter-rouge">android_os_util_Binder.cpp::javaObjectForIBinder()</code></p><div class="language-cpp highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
</pre><td class="rouge-code"><pre><span class="c1">// If the argument is a JavaBBinder, return the Java object that was used to create it.</span>
<span class="c1">// Otherwise return a BinderProxy for the IBinder. If a previous call was passed the</span>
<span class="c1">// same IBinder, and the original BinderProxy is still alive, return the same BinderProxy.</span>
<span class="n">jobject</span> <span class="nf">javaObjectForIBinder</span><span class="p">(</span><span class="n">JNIEnv</span><span class="o">*</span> <span class="n">env</span><span class="p">,</span> <span class="k">const</span> <span class="n">sp</span><span class="o">&lt;</span><span class="n">IBinder</span><span class="o">&gt;&amp;</span> <span class="n">val</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// val 实际是 sp&lt;BpServiceManager&gt;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">val</span><span class="o">-&gt;</span><span class="n">checkSubclass</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gBinderOffsets</span><span class="p">))</span> <span class="p">{</span>
        <span class="c1">// It's a JavaBBinder created by ibinderForJavaObject. Already has Java object.</span>
        <span class="n">jobject</span> <span class="n">object</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">JavaBBinder</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">val</span><span class="p">.</span><span class="n">get</span><span class="p">())</span><span class="o">-&gt;</span><span class="n">object</span><span class="p">();</span>
        <span class="n">LOGDEATH</span><span class="p">(</span><span class="s">"objectForBinder %p: it's our own %p!</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">val</span><span class="p">.</span><span class="n">get</span><span class="p">(),</span> <span class="n">object</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">object</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// For the rest of the function we will hold this lock, to serialize</span>
    <span class="c1">// looking/creation/destruction of Java proxies for native Binder proxies.</span>
    <span class="n">AutoMutex</span> <span class="n">_l</span><span class="p">(</span><span class="n">gProxyLock</span><span class="p">);</span>

    <span class="c1">// gNativeDataCahe 为缓存数据</span>
    <span class="n">BinderProxyNativeData</span><span class="o">*</span> <span class="n">nativeData</span> <span class="o">=</span> <span class="n">gNativeDataCache</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">nativeData</span> <span class="o">==</span> <span class="nb">nullptr</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// 缓存数据为 nullptr，创建对象</span>
        <span class="n">nativeData</span> <span class="o">=</span> <span class="k">new</span> <span class="n">BinderProxyNativeData</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="c1">// gNativeDataCache is now logically empty.</span>
    <span class="c1">// 调用 Java 层 BinderProxy#getInstance() 方法生成 BinderProxy 对象</span>
    <span class="c1">// 3.3 小节分析</span>
    <span class="n">jobject</span> <span class="n">object</span> <span class="o">=</span> <span class="n">env</span><span class="o">-&gt;</span><span class="n">CallStaticObjectMethod</span><span class="p">(</span><span class="n">gBinderProxyOffsets</span><span class="p">.</span><span class="n">mClass</span><span class="p">,</span>
            <span class="n">gBinderProxyOffsets</span><span class="p">.</span><span class="n">mGetInstance</span><span class="p">,</span> <span class="p">(</span><span class="n">jlong</span><span class="p">)</span> <span class="n">nativeData</span><span class="p">,</span> <span class="p">(</span><span class="n">jlong</span><span class="p">)</span> <span class="n">val</span><span class="p">.</span><span class="n">get</span><span class="p">());</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">env</span><span class="o">-&gt;</span><span class="n">ExceptionCheck</span><span class="p">())</span> <span class="p">{</span>
        <span class="c1">// In the exception case, getInstance still took ownership of nativeData.</span>
        <span class="n">gNativeDataCache</span> <span class="o">=</span> <span class="nb">nullptr</span><span class="p">;</span>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="c1">// 获取 Java 层 BinderProxy#mNativeData 字段，即 nativeData 指针</span>
    <span class="n">BinderProxyNativeData</span><span class="o">*</span> <span class="n">actualNativeData</span> <span class="o">=</span> <span class="n">getBPNativeData</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">object</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">actualNativeData</span> <span class="o">==</span> <span class="n">nativeData</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// New BinderProxy; we still have exclusive access.</span>
        <span class="n">nativeData</span><span class="o">-&gt;</span><span class="n">mOrgue</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DeathRecipientList</span><span class="p">;</span>
        <span class="n">nativeData</span><span class="o">-&gt;</span><span class="n">mObject</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
        <span class="n">gNativeDataCache</span> <span class="o">=</span> <span class="nb">nullptr</span><span class="p">;</span>
        <span class="o">++</span><span class="n">gNumProxies</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">gNumProxies</span> <span class="o">&gt;=</span> <span class="n">gProxiesWarned</span> <span class="o">+</span> <span class="n">PROXY_WARN_INTERVAL</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">gProxiesWarned</span> <span class="o">=</span> <span class="n">gNumProxies</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="c1">// 首次调用时：</span>
        <span class="c1">// nativeData = new BinderProxyNativeData, gNativeDataCache = nullptr</span>
        <span class="c1">// 将 nativeData 缓存起来，下次使用</span>
        <span class="n">gNativeDataCache</span> <span class="o">=</span> <span class="n">nativeData</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">object</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><p>3.3、<code class="language-plaintext highlighter-rouge">BinderProxy#getInstance()</code></p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
</pre><td class="rouge-code"><pre><span class="kd">private</span> <span class="kd">static</span> <span class="nc">BinderProxy</span> <span class="nf">getInstance</span><span class="o">(</span><span class="kt">long</span> <span class="n">nativeData</span><span class="o">,</span> <span class="kt">long</span> <span class="n">iBinder</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// nativeDate 是指向 native 层 BinderProxyNativeData 结构体的指针</span>
    <span class="c1">// iBinder 是指向 native 层 BpServiceManager 对象的指针</span>
    <span class="nc">BinderProxy</span> <span class="n">result</span><span class="o">;</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="c1">// 查一下缓存中是否有 iBinder 指针对应的 Java 层 BinderProxy 对象</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">sProxyMap</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">iBinder</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">result</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="c1">// 创建一个 BinderProxy 对象，并将 mNativeData 字段指向 native 层 </span>
        <span class="c1">// nativeData 指针</span>
        <span class="n">result</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">BinderProxy</span><span class="o">(</span><span class="n">nativeData</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Throwable</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// We're throwing an exception (probably OOME); don't drop nativeData.</span>
        <span class="nc">NativeAllocationRegistry</span><span class="o">.</span><span class="na">applyFreeFunction</span><span class="o">(</span>
            <span class="nc">NoImagePreloadHolder</span><span class="o">.</span><span class="na">sNativeFinalizer</span><span class="o">,</span> <span class="n">nativeData</span><span class="o">);</span>
        <span class="k">throw</span> <span class="n">e</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="c1">// 为 BinderProxy 对象分配 native 内存，并与 Java 层的对象建立关联</span>
    <span class="c1">// registerNativeAllocation 函数内部使用到了 Reference 对象，猜测可能与 GC</span>
    <span class="c1">// 有关，这里不做详细分析</span>
    <span class="nc">NoImagePreloadHolder</span><span class="o">.</span><span class="na">sRegistry</span><span class="o">.</span><span class="na">registerNativeAllocation</span><span class="o">(</span><span class="n">result</span><span class="o">,</span> <span class="n">nativeData</span><span class="o">);</span>
    <span class="c1">// The registry now owns nativeData, even if registration threw an exception.</span>
    <span class="c1">// 缓存数据</span>
    <span class="n">sProxyMap</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">iBinder</span><span class="o">,</span> <span class="n">result</span><span class="o">);</span>
    <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
<span class="o">}</span>
</pre></table></code></div></div><p>3.4、<code class="language-plaintext highlighter-rouge">BinderInternal#getContextObject()</code> 方法小结：</p><ul><li>通过 JNI 调用，创建一个 Java 层的 BinderProxy 对象；<li>通过 JNI 调用，将 BinderProxy 对象与 native 层的 BpProxy 对象建立关联，该 BpProxy 就是 BpServiceManager，其通信目标就是 ServiceManager</ul><p>4、<code class="language-plaintext highlighter-rouge">ServiceManagerNative#asInterface()</code></p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre><td class="rouge-code"><pre><span class="kd">static</span> <span class="kd">public</span> <span class="nc">IServiceManager</span> <span class="nf">asInterface</span><span class="o">(</span><span class="nc">IBinder</span> <span class="n">obj</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// obj 是一个 BinderProxy 对象的实例</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">obj</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="c1">// descriptor = "android.os.IServiceManager" 与 native 层是保持一致的</span>
    <span class="nc">IServiceManager</span> <span class="n">in</span> <span class="o">=</span> <span class="o">(</span><span class="nc">IServiceManager</span><span class="o">)</span><span class="n">obj</span><span class="o">.</span><span class="na">queryLocalInterface</span><span class="o">(</span><span class="n">descriptor</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">in</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">in</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="c1">// 以 obj 为参数，创建 ServiceManagerProxy 对象，赋值给 mRemote 字段</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nf">ServiceManagerProxy</span><span class="o">(</span><span class="n">obj</span><span class="o">);</span>
<span class="o">}</span>
</pre></table></code></div></div><p>5、<code class="language-plaintext highlighter-rouge">ServiceManagerProxy#addService()</code></p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kt">void</span> <span class="nf">addService</span><span class="o">(</span><span class="nc">String</span> <span class="n">name</span><span class="o">,</span> <span class="nc">IBinder</span> <span class="n">service</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">allowIsolated</span><span class="o">,</span>
    <span class="kt">int</span> <span class="n">dumpPriority</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">RemoteException</span> <span class="o">{</span>
    <span class="nc">Parcel</span> <span class="n">data</span> <span class="o">=</span> <span class="nc">Parcel</span><span class="o">.</span><span class="na">obtain</span><span class="o">();</span>
    <span class="nc">Parcel</span> <span class="n">reply</span> <span class="o">=</span> <span class="nc">Parcel</span><span class="o">.</span><span class="na">obtain</span><span class="o">();</span>
    <span class="c1">// descriptor = "android.os.IServiceManager"</span>
    <span class="n">data</span><span class="o">.</span><span class="na">writeInterfaceToken</span><span class="o">(</span><span class="nc">IServiceManager</span><span class="o">.</span><span class="na">descriptor</span><span class="o">);</span>
    <span class="n">data</span><span class="o">.</span><span class="na">writeString</span><span class="o">(</span><span class="n">name</span><span class="o">);</span> <span class="c1">// service name</span>
    <span class="c1">// writeStrongBinder() 最终会调用 nativeWriteStrongBinder()，其具体实现在</span>
    <span class="c1">// android_os_Parcel.cpp::android_os_Parcel_writeStrongBinder() 中，在下一节</span>
    <span class="c1">// 进行分析</span>
    <span class="n">data</span><span class="o">.</span><span class="na">writeStrongBinder</span><span class="o">(</span><span class="n">service</span><span class="o">);</span> <span class="c1">// service 对象（IBinder）</span>
    <span class="n">data</span><span class="o">.</span><span class="na">writeInt</span><span class="o">(</span><span class="n">allowIsolated</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="o">);</span>
    <span class="n">data</span><span class="o">.</span><span class="na">writeInt</span><span class="o">(</span><span class="n">dumpPriority</span><span class="o">);</span>
    <span class="c1">// 调用 BinderProxy#transact() 函数</span>
    <span class="n">mRemote</span><span class="o">.</span><span class="na">transact</span><span class="o">(</span><span class="no">ADD_SERVICE_TRANSACTION</span><span class="o">,</span> <span class="n">data</span><span class="o">,</span> <span class="n">reply</span><span class="o">,</span> <span class="mi">0</span><span class="o">);</span>
    <span class="n">reply</span><span class="o">.</span><span class="na">recycle</span><span class="o">();</span>
    <span class="n">data</span><span class="o">.</span><span class="na">recycle</span><span class="o">();</span>
<span class="o">}</span>
</pre></table></code></div></div><p>将数据打包成 Parcel 对象之后发送给 remote 端</p><p>6、<code class="language-plaintext highlighter-rouge">BinderProxy#transact()</code></p><p>该函数最终会调用到 <code class="language-plaintext highlighter-rouge">BinderProxy#transactNative()</code> 函数，该 函数为 native 函数， 其具体实现为 <code class="language-plaintext highlighter-rouge">android_util_Binder.cpp::android_os_BinderProxy_transact()</code></p><div class="language-cpp highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
</pre><td class="rouge-code"><pre><span class="k">static</span> <span class="n">jboolean</span> <span class="nf">android_os_BinderProxy_transact</span><span class="p">(</span><span class="n">JNIEnv</span><span class="o">*</span> <span class="n">env</span><span class="p">,</span> <span class="n">jobject</span> <span class="n">obj</span><span class="p">,</span>
        <span class="n">jint</span> <span class="n">code</span><span class="p">,</span> <span class="n">jobject</span> <span class="n">dataObj</span><span class="p">,</span> <span class="n">jobject</span> <span class="n">replyObj</span><span class="p">,</span> <span class="n">jint</span> <span class="n">flags</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// throws RemoteException</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">dataObj</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">jniThrowNullPointerException</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">JNI_FALSE</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="c1">// 将 Java 层 Parcel 对象装换为 native 层 Parcel 对象</span>
    <span class="n">Parcel</span><span class="o">*</span> <span class="n">data</span> <span class="o">=</span> <span class="n">parcelForJavaObject</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">dataObj</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">data</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">JNI_FALSE</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">Parcel</span><span class="o">*</span> <span class="n">reply</span> <span class="o">=</span> <span class="n">parcelForJavaObject</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">replyObj</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">reply</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="n">replyObj</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">JNI_FALSE</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// getBPNativeData(env, obj) 获取指向 gNativeDataCache 的指针，然后获取</span>
    <span class="c1">// BinderProxyNativeData 中 mObject 成员，该字段指向 native 层 IBinder</span>
    <span class="c1">// 此处即 BpServiceManager 对象</span>
    <span class="n">IBinder</span><span class="o">*</span> <span class="n">target</span> <span class="o">=</span> <span class="n">getBPNativeData</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">obj</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">mObject</span><span class="p">.</span><span class="n">get</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">target</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">jniThrowException</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="s">"java/lang/IllegalStateException"</span><span class="p">,</span> <span class="s">"Binder has been finalized!"</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">JNI_FALSE</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// 通过 native BpBinder 对象将数据发送给 ServiceManager</span>
    <span class="n">status_t</span> <span class="n">err</span> <span class="o">=</span> <span class="n">target</span><span class="o">-&gt;</span><span class="n">transact</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="n">reply</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="n">NO_ERROR</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">JNI_TRUE</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="n">UNKNOWN_TRANSACTION</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">JNI_FALSE</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">signalExceptionForError</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="nb">true</span> <span class="cm">/*canThrowRemoteException*/</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">dataSize</span><span class="p">());</span>
    <span class="k">return</span> <span class="n">JNI_FALSE</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><h3 id="揭开-parcelwritestrongbinder-神秘的面纱">揭开 <code class="language-plaintext highlighter-rouge">Parcel#writeStrongBinder()</code> 神秘的面纱</h3><p>1、Parcel#writeStrongBinder() 最终会调用到 Parcel#nativeWriteStrongBinder()，这是 个 native 方法，实现为 <code class="language-plaintext highlighter-rouge">android_os_Parcel.cpp::android_os_Parcel_writeStrongBinder()</code></p><div class="language-cpp highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre><span class="k">static</span> <span class="kt">void</span> <span class="nf">android_os_Parcel_writeStrongBinder</span><span class="p">(</span><span class="n">JNIEnv</span><span class="o">*</span> <span class="n">env</span><span class="p">,</span> <span class="n">jclass</span> <span class="n">clazz</span><span class="p">,</span>
    <span class="n">jlong</span> <span class="n">nativePtr</span><span class="p">,</span> <span class="n">jobject</span> <span class="n">object</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// 此处的 object 为 Java 层的 Binder 对象</span>
    <span class="n">Parcel</span><span class="o">*</span> <span class="n">parcel</span> <span class="o">=</span> <span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="n">Parcel</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">nativePtr</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">parcel</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// 接下来会调用 ibinderForJavaObject() 返回一个 native 层的 IBinder 对象</span>
        <span class="k">const</span> <span class="n">status_t</span> <span class="n">err</span> <span class="o">=</span> <span class="n">parcel</span><span class="o">-&gt;</span><span class="n">writeStrongBinder</span><span class="p">(</span><span class="n">ibinderForJavaObject</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">object</span><span class="p">));</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">!=</span> <span class="n">NO_ERROR</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">signalExceptionForError</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">clazz</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>2、<code class="language-plaintext highlighter-rouge">android_util_Binder.cpp::ibinderForJavaObject()</code></p><p>见名知意，此方法为 Java 层 Binder 生成一个 native 层 IBinder 对象，下面分析这里是 如何实现的：</p><div class="language-cpp highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre><td class="rouge-code"><pre><span class="n">sp</span><span class="o">&lt;</span><span class="n">IBinder</span><span class="o">&gt;</span> <span class="n">ibinderForJavaObject</span><span class="p">(</span><span class="n">JNIEnv</span><span class="o">*</span> <span class="n">env</span><span class="p">,</span> <span class="n">jobject</span> <span class="n">obj</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// obj 为 Java 层的 Binder 对象</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">obj</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="c1">// Instance of Binder?</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">env</span><span class="o">-&gt;</span><span class="n">IsInstanceOf</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">gBinderOffsets</span><span class="p">.</span><span class="n">mClass</span><span class="p">))</span> <span class="p">{</span>
        <span class="c1">// 通过 JNI 向上调用 Java 类中的字段得到 JavaBBinderHolder 对象</span>
        <span class="n">JavaBBinderHolder</span><span class="o">*</span> <span class="n">jbh</span> <span class="o">=</span> <span class="p">(</span><span class="n">JavaBBinderHolder</span><span class="o">*</span><span class="p">)</span>
            <span class="n">env</span><span class="o">-&gt;</span><span class="n">GetLongField</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">gBinderOffsets</span><span class="p">.</span><span class="n">mObject</span><span class="p">);</span>
        <span class="c1">// get() 方法，返回 JavaBBinder 对象</span>
        <span class="c1">// 注意：JavaBBinder 继承自 BBinder，而 BBinder 继承自 IBinder</span>
        <span class="k">return</span> <span class="n">jbh</span><span class="o">-&gt;</span><span class="n">get</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">obj</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="c1">// Instance of BinderProxy?</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">env</span><span class="o">-&gt;</span><span class="n">IsInstanceOf</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">gBinderProxyOffsets</span><span class="p">.</span><span class="n">mClass</span><span class="p">))</span> <span class="p">{</span>
        <span class="c1">// 直接取出</span>
        <span class="k">return</span> <span class="n">getBPNativeData</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">obj</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">mObject</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><p>从这里可以推断 Java 层 Binder#mObject 字段对应 native 层 JavaBBinderHolder 对象， 对象，那么 mObject 字段是何时赋值的呢？答案就在 Binder 的构造器中！</p><p>3、Java 层 Binder 构造</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="nf">Binder</span><span class="o">()</span> <span class="o">{</span>
    <span class="c1">// native 方法，实现为 android_os_Binder_getNativeBBinderHolder()</span>
    <span class="n">mObject</span> <span class="o">=</span> <span class="n">getNativeBBinderHolder</span><span class="o">();</span>
    <span class="nc">NoImagePreloadHolder</span><span class="o">.</span><span class="na">sRegistry</span><span class="o">.</span><span class="na">registerNativeAllocation</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">mObject</span><span class="o">);</span>
<span class="o">}</span>
</pre></table></code></div></div><div class="language-cpp highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="k">static</span> <span class="n">jlong</span> <span class="nf">android_os_Binder_getNativeBBinderHolder</span><span class="p">(</span><span class="n">JNIEnv</span><span class="o">*</span> <span class="n">env</span><span class="p">,</span>
    <span class="n">jobject</span> <span class="n">clazz</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// 直接实例化一个 JavaBBinderHolder 对象返回给 Java 层 Binder#mObject 字段</span>
    <span class="n">JavaBBinderHolder</span><span class="o">*</span> <span class="n">jbh</span> <span class="o">=</span> <span class="k">new</span> <span class="n">JavaBBinderHolder</span><span class="p">();</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">jlong</span><span class="p">)</span> <span class="n">jbh</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><p>从类的名字来看，JavaBBinderHolder 只是一层外衣，真正的数据是其内部的 “JavaBBinder” 那么 JavaBBinderHolder 又是何方与 JavaBBinder 建立联系的呢？答案就在其 get() 方法</p><p>4、<code class="language-plaintext highlighter-rouge">android_util_Binder.cpp::JavaBBinderHolder::get()</code></p><div class="language-cpp highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre><td class="rouge-code"><pre><span class="n">sp</span><span class="o">&lt;</span><span class="n">JavaBBinder</span><span class="o">&gt;</span> <span class="n">get</span><span class="p">(</span><span class="n">JNIEnv</span><span class="o">*</span> <span class="n">env</span><span class="p">,</span> <span class="n">jobject</span> <span class="n">obj</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// obj 为 Java 层的 Binder 对象</span>
    <span class="n">AutoMutex</span> <span class="n">_l</span><span class="p">(</span><span class="n">mLock</span><span class="p">);</span>
    <span class="n">sp</span><span class="o">&lt;</span><span class="n">JavaBBinder</span><span class="o">&gt;</span> <span class="n">b</span> <span class="o">=</span> <span class="n">mBinder</span><span class="p">.</span><span class="n">promote</span><span class="p">();</span>
    <span class="c1">// 如果还没有与 JavaBBinder 建立关联，则创建 JavaBBinder 对象并赋值给 mBinder</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">b</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// 简单分析 JavaBBinder 类</span>
        <span class="n">b</span> <span class="o">=</span> <span class="k">new</span> <span class="n">JavaBBinder</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">obj</span><span class="p">);</span>
        <span class="n">mBinder</span> <span class="o">=</span> <span class="n">b</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="c1">// 已建立关联，直接返回</span>
    <span class="k">return</span> <span class="n">b</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><p>5、<code class="language-plaintext highlighter-rouge">android_util_Binder.cpp::JavaBBinder</code></p><p>JavaBBinder 继承自 BBinder</p><div class="language-cpp highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
</pre><td class="rouge-code"><pre><span class="k">class</span> <span class="nc">JavaBBinder</span> <span class="o">:</span> <span class="k">public</span> <span class="n">BBinder</span> <span class="p">{</span>
<span class="nl">private:</span>
    <span class="n">JavaVM</span><span class="o">*</span> <span class="k">const</span>   <span class="n">mVM</span><span class="p">;</span>
    <span class="n">jobject</span> <span class="k">const</span>   <span class="n">mObject</span><span class="p">;</span>  <span class="c1">// Java Binder 全局引用</span>

<span class="nl">public:</span>
    <span class="n">JavaBBinder</span><span class="p">(</span><span class="n">JNIEnv</span><span class="o">*</span> <span class="n">env</span><span class="p">,</span> <span class="n">jobject</span> <span class="cm">/* Java Binder */</span> <span class="n">object</span><span class="p">)</span>
        <span class="o">:</span> <span class="n">mVM</span><span class="p">(</span><span class="n">jnienv_to_javavm</span><span class="p">(</span><span class="n">env</span><span class="p">)),</span> <span class="n">mObject</span><span class="p">(</span><span class="n">env</span><span class="o">-&gt;</span><span class="n">NewGlobalRef</span><span class="p">(</span><span class="n">object</span><span class="p">))</span> <span class="p">{</span>
        <span class="c1">// new 一个全局引用并赋值给 mObject 字段</span>
    <span class="p">}</span>

    <span class="c1">// 返回 Java Binder</span>
    <span class="n">jobject</span> <span class="n">object</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">mObject</span><span class="p">;</span>
    <span class="p">}</span>

<span class="nl">protected:</span>
    <span class="k">virtual</span> <span class="n">status_t</span> <span class="n">onTransact</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="n">code</span><span class="p">,</span> <span class="k">const</span> <span class="n">Parcel</span><span class="o">&amp;</span> <span class="n">data</span><span class="p">,</span> <span class="n">Parcel</span><span class="o">*</span> <span class="n">reply</span><span class="p">,</span>
        <span class="kt">uint32_t</span> <span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// 执行 Binder#execTransact() 方法响应客户端 Binder 请求，下节分析</span>
        <span class="n">jboolean</span> <span class="n">res</span> <span class="o">=</span> <span class="n">env</span><span class="o">-&gt;</span><span class="n">CallBooleanMethod</span><span class="p">(</span><span class="n">mObject</span><span class="p">,</span> <span class="n">gBinderOffsets</span><span class="p">.</span><span class="n">mExecTransact</span><span class="p">,</span>
            <span class="n">code</span><span class="p">,</span> <span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="n">jlong</span><span class="o">&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="p">),</span> <span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="n">jlong</span><span class="o">&gt;</span><span class="p">(</span><span class="n">reply</span><span class="p">),</span> <span class="n">flags</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">res</span> <span class="o">!=</span> <span class="n">JNI_FALSE</span> <span class="o">?</span> <span class="n">NO_ERROR</span> <span class="o">:</span> <span class="n">UNKNOWN_TRANSACTION</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">};</span>
</pre></table></code></div></div><h3 id="小结-1">小结</h3><p>通过上面的分析，Java 层 SM#addService() 实际添加到 native 层 ServiceManager 的其 实并不是 AMS 本身，而是一个 JavaBBinder 对象，addService() 的本质是将此对象传递给 binder 驱动。</p><p>Java Binder、JavaBBinderHolder、JavaBBinder、BBinder 之间的关系如下：<br /> <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 " data-src="/assets/android/binder-java-b-binder-holder.png" alt="缺图一张" /><br /> 从上图我们可以看出：</p><ul><li>Java 层 Binder 通过 mObject 字段指向 native 层的 JavaBBinderHolder 对象；<li>native 层 JavaBBinderHolder 又通过 mBinder 字段指向 native 层 JavaBBinder 对象；<li>native 层 JavaBBinder 又通过 mObject 字段指向 Java 层的 Binder 对象；</ul><p><strong>思考</strong>：<br /></p><ul><li>为什么不直接让 Java 层的 Binder 对象指向 native 层的 JavaBBinder 对象呢？分析 上述三个类，发现 JavaBBinderHolder 中用到了 sp<T> 弱引用，因此可以猜测应该和内存 管理有关。</T><li>Java 层添加到 native 层 ServiceManager 中的 service（Binder） 其实都对应着一个 native 层的 JavaBBinder。</ul><h2 id="ams-响应客户端的-binder-请求">AMS 响应客户端的 Binder 请求</h2><p>以 Activity#startActivity() 方法为例分析 AMS 如何响应客户端的 Binder 请求，具体调用 流程如下：</p><pre>
========client========
ClientActivity#startActivity() -&gt;
Activity#startActivity() -&gt;
ContextImpl#startActivity() -&gt;
Instrumentation#execStartActivity() -&gt;
========service manager========
ActivityManager.getService().startActivity() -&gt;
  1. ActivityManager.getService() -&gt; IActivityManagerSingleton.get() -&gt;
    android.util.Singleton.get() -&gt; Singleton.create() -&gt;
  2. return IActivityManager.Stub.asInterface(ServiceManager.getService("activity"))
    // JNI 调用从 service manager 中获取
    ServiceManager.getService("activity") =&gt; BinderProxy
  3. IActivityManager.Stub.asInterface(b) -&gt; new IActivityManager.Stub.Proxy(b)
    mRemote =&gt; b =&gt; BinderProxy
------- java 层 --------
IActivityManager.Stub.Proxy().startActivity() -&gt;
mRemote.transact(Stub.TRANSACTION_startActivity) -&gt;
BinderProxy#transact() -&gt; transactNative() -&gt;
------- jni 层 --------
android_util_Binder.cpp::android_os_BinderProxy_transact() -&gt; target::transact()
native IBinder::transact() -&gt; BBinder::transact() -&gt; Binder.cpp::transact() -&gt; Binder.cpp::onTransact() -&gt;
android_util_Binder.cpp::JavaBBinder::onTransact() -&gt;
------- java 层 --------
Binder#execTransact() -&gt; onTransact() -&gt;
IActivitymanager.Stub#onTransact() -&gt; onTransact() =&gt; TRANSACTION_startActivity
IActivityManager.Stub#onTransact$startActivity$() -&gt;
========AMS========
ActivityManagerService#startActivity()
  ActivityManagerService 继承自IActivityManager.Stub.Proxy， 而 Proxy 又继承自 IActivityManager
</pre><h3 id="客户端发起-binder-请求">客户端发起 Binder 请求</h3><p>当客户端 Activity 发起 startActivity() 请求时，最终会从 app 进程调用到 system_server 进程，不过在使用系统服务之前必须要先通过 SM 获取到该服务。</p><h3 id="通过-sm-获取-ams">通过 SM 获取 AMS</h3><p>系统获取 AMS 的过程就不详细分析了</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre><span class="nd">@Override</span>
<span class="kd">protected</span> <span class="nc">IActivityManager</span> <span class="nf">create</span><span class="o">()</span> <span class="o">{</span>
    <span class="c1">// 这里返回的 IBinder 对象其实就是 BinderProxy</span>
    <span class="kd">final</span> <span class="nc">IBinder</span> <span class="n">b</span> <span class="o">=</span> <span class="nc">ServiceManager</span><span class="o">.</span><span class="na">getService</span><span class="o">(</span><span class="s">"activity"</span><span class="o">);</span>
    <span class="c1">// 这里实际创建的是 IActivityManager.Stub.Proxy() 对象，IActivityManager.Stub</span>
    <span class="c1">// 是抽象类并继承自 IActivityManager，其实际实现子类是 AMS</span>
    <span class="c1">// 这里的 ibinder 最终传给了 IActivityManager.Stub.Proxy 的 mRemote 字段</span>
    <span class="k">return</span> <span class="nc">IActivityManager</span><span class="o">.</span><span class="na">Stub</span><span class="o">.</span><span class="na">asInterface</span><span class="o">(</span><span class="n">b</span><span class="o">);</span>
<span class="o">}</span>
</pre></table></code></div></div><h3 id="ams-响应客户端请求">AMS 响应客户端请求</h3><p>1、客户端发起的 startActivity() 调用最先到达 IActivityManager.Stub.Proxy#startActivity()， 然后通过调用 <code class="language-plaintext highlighter-rouge">mRemote.transact(Stub.TRANSACTION_startActivity)</code> 进行转发，那么下一 步会调用到 <code class="language-plaintext highlighter-rouge">BinderProxy#transact()</code> 方法，并进一步通过 transactNative() 调用到 native 层 <code class="language-plaintext highlighter-rouge">android_util_Binder.cpp::android_os_BinderProxy_transact()</code> 方法：</p><p>2、<code class="language-plaintext highlighter-rouge">android_util_Binder.cpp::android_os_BinderProxy_transact()</code></p><div class="language-cpp highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre><span class="k">static</span> <span class="n">jboolean</span> <span class="nf">android_os_BinderProxy_transact</span><span class="p">(</span><span class="n">JNIEnv</span><span class="o">*</span> <span class="n">env</span><span class="p">,</span> <span class="n">jobject</span> <span class="n">obj</span><span class="p">,</span>
        <span class="n">jint</span> <span class="n">code</span><span class="p">,</span> <span class="n">jobject</span> <span class="n">dataObj</span><span class="p">,</span> <span class="n">jobject</span> <span class="n">replyObj</span><span class="p">,</span> <span class="n">jint</span> <span class="n">flags</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// throws RemoteException</span>
    <span class="c1">// ...</span>
    <span class="c1">// 这里获取到的是 JavaBBinder 对象，该对象继承自 native IBinder</span>
    <span class="n">IBinder</span><span class="o">*</span> <span class="n">target</span> <span class="o">=</span> <span class="n">getBPNativeData</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">obj</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">mObject</span><span class="p">.</span><span class="n">get</span><span class="p">();</span>
    <span class="c1">// 此方法会调用父类 transact() 方法并最终调用 Binder.cpp::onTransact() 方法，</span>
    <span class="c1">// 这里其子类为 JavaBBinder，所以会调用 JavaBBinder::onTransact() 方法</span>
    <span class="n">status_t</span> <span class="n">err</span> <span class="o">=</span> <span class="n">target</span><span class="o">-&gt;</span><span class="n">transact</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="n">reply</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
    <span class="c1">// ...</span>
    <span class="k">return</span> <span class="n">JNI_FALSE</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><p>3、<code class="language-plaintext highlighter-rouge">android_util_Binder.cpp::JavaBBinder::onTransact()</code></p><div class="language-cpp highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="k">virtual</span> <span class="n">status_t</span> <span class="nf">onTransact</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="n">code</span><span class="p">,</span> <span class="k">const</span> <span class="n">Parcel</span><span class="o">&amp;</span> <span class="n">data</span><span class="p">,</span> <span class="n">Parcel</span><span class="o">*</span> <span class="n">reply</span><span class="p">,</span>
    <span class="kt">uint32_t</span> <span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// 通过 JNI 向上调用 Java Binder#execTransact() 方法</span>
    <span class="n">jboolean</span> <span class="n">res</span> <span class="o">=</span> <span class="n">env</span><span class="o">-&gt;</span><span class="n">CallBooleanMethod</span><span class="p">(</span><span class="n">mObject</span><span class="p">,</span> <span class="n">gBinderOffsets</span><span class="p">.</span><span class="n">mExecTransact</span><span class="p">,</span>
        <span class="n">code</span><span class="p">,</span> <span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="n">jlong</span><span class="o">&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="p">),</span> <span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="n">jlong</span><span class="o">&gt;</span><span class="p">(</span><span class="n">reply</span><span class="p">),</span> <span class="n">flags</span><span class="p">);</span>
    <span class="c1">// ....</span>
    <span class="k">return</span> <span class="n">res</span> <span class="o">!=</span> <span class="n">JNI_FALSE</span> <span class="o">?</span> <span class="n">NO_ERROR</span> <span class="o">:</span> <span class="n">UNKNOWN_TRANSACTION</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><p>4、Java <code class="language-plaintext highlighter-rouge">Binder#execTransact()</code></p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
</pre><td class="rouge-code"><pre><span class="kd">private</span> <span class="kt">boolean</span> <span class="nf">execTransact</span><span class="o">(</span><span class="kt">int</span> <span class="n">code</span><span class="o">,</span> <span class="kt">long</span> <span class="n">dataObj</span><span class="o">,</span> <span class="kt">long</span> <span class="n">replyObj</span><span class="o">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// 从 native Parcel 转换成 Java Parcel</span>
    <span class="nc">Parcel</span> <span class="n">data</span> <span class="o">=</span> <span class="nc">Parcel</span><span class="o">.</span><span class="na">obtain</span><span class="o">(</span><span class="n">dataObj</span><span class="o">);</span>
    <span class="nc">Parcel</span> <span class="n">reply</span> <span class="o">=</span> <span class="nc">Parcel</span><span class="o">.</span><span class="na">obtain</span><span class="o">(</span><span class="n">replyObj</span><span class="o">);</span>
    <span class="kt">boolean</span> <span class="n">res</span><span class="o">;</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="c1">// 直接调用 onTransact() 方法，一般都是由子类实现，在 AIDL 中都是由</span>
        <span class="c1">// IXxx.Stub#onTransact() 来进行分发给实现类的各种业务调用，比如此处调用的</span>
        <span class="c1">// startActivity() 最终会调用到 AMS#startActivity()</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">onTransact</span><span class="o">(</span><span class="n">code</span><span class="o">,</span> <span class="n">data</span><span class="o">,</span> <span class="n">reply</span><span class="o">,</span> <span class="n">flags</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">RemoteException</span><span class="o">|</span><span class="nc">RuntimeException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">((</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="no">FLAG_ONEWAY</span><span class="o">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">e</span> <span class="k">instanceof</span> <span class="nc">RemoteException</span><span class="o">)</span> <span class="o">{</span>
                <span class="nc">Log</span><span class="o">.</span><span class="na">w</span><span class="o">(</span><span class="no">TAG</span><span class="o">,</span> <span class="s">"Binder call failed."</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="nc">Log</span><span class="o">.</span><span class="na">w</span><span class="o">(</span><span class="no">TAG</span><span class="o">,</span> <span class="s">"Caught a RuntimeException from the binder stub implementation."</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="c1">// Clear the parcel before writing the exception</span>
            <span class="n">reply</span><span class="o">.</span><span class="na">setDataSize</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
            <span class="n">reply</span><span class="o">.</span><span class="na">setDataPosition</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
            <span class="n">reply</span><span class="o">.</span><span class="na">writeException</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="n">res</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="c1">// 释放资源</span>
    <span class="n">reply</span><span class="o">.</span><span class="na">recycle</span><span class="o">();</span>
    <span class="n">data</span><span class="o">.</span><span class="na">recycle</span><span class="o">();</span>
    <span class="k">return</span> <span class="n">res</span><span class="o">;</span>
<span class="o">}</span>
</pre></table></code></div></div><h3 id="小结-2">小结</h3><p>通过以上的分析发现 Java 层 Binder 架构中 JavaBBinder 并不承担处理实际业务的职责；</p><ul><li>当收到请求时，JavaBBinder 通过 JNI 向上调用其绑定的 Java Binder 对象的 execTransact();<li>Java Binder#execTransact() 最终调用子类实现的 onTransact() 函数；<li>子类通过 onTransact() 函数将任务派发给最终的子类来完成</ul><p>以下是 AMS 响应 Binder 请求的整个流程： <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 " data-src="/assets/android/binder-ams-response-request.png" alt="ams-response-binder-request" /></p><h2 id="总结">总结</h2><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 " data-src="/assets/android/binder-java-natice-arch.png" alt="android-binder-arch" /></p><ul><li>对于客户端的 BinderProxy 来讲，Java 层的 BinderProxy 在 native 层对应着一个 BpBinder 对象；凡是从 Java 层发出的请求，首先从 BinderProxy 传递到 native 层的 BpBinder，继而 由 BpBinder 将请求发送到 binder 驱动<li>对于代表服务端的 Service 来讲，Java 层的 Binder 在 native 层有一个 JavaBBinder 对 象；但 JavaBBinder 只起到中转作用，即把来自客户端的请求从 native 层传递到 Java 层<li>无论是 Java 层还是 native 层，自始至终都只有一个 ServiceManager</ul><p>1、从 IPC 角度来说：binder 是 Android 系统提供的一种 IPC 机制，该方式为 Android 独有； 2、从 Android 驱动层：binder 可以理解为一种虚拟的物理设备，其启动是 /dev/binder； 3、从 Android native 层：binder 是创建 ServiceManager 以及 BpBinder/BBinder 模型， 搭建与 binder 驱动的桥梁； 4、从 Android 框架层：binder 是各种系统 xxxService 与 xxxManager 的桥梁； 5、从 Android APP 层：binder 是客户端和服务端进行通信的媒介，当 bindService() 时， 服务端会返回一个包含了服务端业务调用的 Binder 对象，通过这个对象客户端就可以获取服务 端提供的服务或数据，这里的服务包括普通服务和基于 AIDL 的服务；</p><h2 id="参考资料">参考资料</h2><ul><li>《深入理解Android卷1》（邓凡平）第六章：深入理解 Binder</ul></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/android/'>android</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/android/" class="post-tag no-text-decoration" >android</a> <a href="/tags/framework/" class="post-tag no-text-decoration" >framework</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Android binder 架构： java 层 - sleticalboy&url=https://sleticalboy.github.io/android/2021/01/08/android-binder-architecture-2/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Android binder 架构： java 层 - sleticalboy&u=https://sleticalboy.github.io/android/2021/01/08/android-binder-architecture-2/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=Android binder 架构： java 层 - sleticalboy&url=https://sleticalboy.github.io/android/2021/01/08/android-binder-architecture-2/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/android/2019/04/09/app%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-01/">app 启动流程源码分析-1</a><li><a href="/android/2019/04/13/app%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-02/">app 启动流程分析-2</a><li><a href="/open-source/2019/01/17/glide/">Glide 图片加载框架</a><li><a href="/open-source/2019/01/17/retrofit/">Retrofit</a><li><a href="/open-source/2019/07/08/okhttp/">OkHttp</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/android/">android</a> <a class="post-tag" href="/tags/framework/">framework</a> <a class="post-tag" href="/tags/english/">english</a> <a class="post-tag" href="/tags/linux/">linux</a> <a class="post-tag" href="/tags/tools/">tools</a> <a class="post-tag" href="/tags/open-source/">open source</a> <a class="post-tag" href="/tags/book/">book</a> <a class="post-tag" href="/tags/java/">java</a> <a class="post-tag" href="/tags/aosp/">aosp</a> <a class="post-tag" href="/tags/git/">git</a></div></div></div><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/android/2019/04/09/app%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-01/"><div class="card-body"> <span class="timeago small" > Apr 9, 2019 <i class="unloaded">2019-04-09T05:38:47+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>app 启动流程源码分析-1</h3><div class="text-muted small"><p> 源码 基于 android 8.0 从点击桌面 app 图标到 ActivityThread 的 main() 方法执行 先来两张图(先凑合下吧，没找到合适的画图工具，找到了再补上=_=) Launcher /packages/apps/Launcher2/src/com/android/launcher2/Launcher.java 什么是 Launcher ...</p></div></div></a></div><div class="card"> <a href="/android/2019/04/13/app%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-02/"><div class="card-body"> <span class="timeago small" > Apr 13, 2019 <i class="unloaded">2019-04-13T23:40:34+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>app 启动流程分析-2</h3><div class="text-muted small"><p> 源码 基于 android 8.0 从 ActivityThread 的 main() 方法执行到页面显示 开篇之前，先思考以下几个问题 Q1: Application 是如何创建的？ Q2: Application 的 attachBaseContext() 为什么会在 onCreate() 方法之前调用？ Q3: Activity 是如何被创建的？ Q4: A...</p></div></div></a></div><div class="card"> <a href="/android/2021/01/04/android-implement-a-native-service/"><div class="card-body"> <span class="timeago small" > Jan 4 <i class="unloaded">2021-01-04T20:53:51+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>实战：使用 Binder 机制实现 C/S 架构</h3><div class="text-muted small"><p> 第一种：native 层实现 声明 service 业务接口 #ifndef ANDROID_ITESTSERVICE_H #define ANDROID_ITESTSERVICE_H #include &lt;binder/IInterface.h&gt; #include &lt;binder/Parcel.h&gt; // 命名空间为 android namespace and...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/android/2021/01/04/android-implement-a-native-service/" class="btn btn-outline-primary"><p>实战：使用 Binder 机制实现 C/S 架构</p></a> <a href="/android/2021/01/11/android-pm-doc/" class="btn btn-outline-primary"><p>Android pm 命令使用文档</p></a></div></div></div></div><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lozad/dist/lozad.min.js"></script> <script type="text/javascript"> const imgs = document.querySelectorAll('#post-wrapper img'); const observer = lozad(imgs); observer.observe(); </script><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2021 <a href="https://github.com/sleticalboy">BenLee</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy/" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-xl-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/android/">android</a> <a class="post-tag" href="/tags/framework/">framework</a> <a class="post-tag" href="/tags/english/">english</a> <a class="post-tag" href="/tags/linux/">linux</a> <a class="post-tag" href="/tags/tools/">tools</a> <a class="post-tag" href="/tags/open-source/">open source</a> <a class="post-tag" href="/tags/book/">book</a> <a class="post-tag" href="/tags/java/">java</a> <a class="post-tag" href="/tags/aosp/">aosp</a> <a class="post-tag" href="/tags/git/">git</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://sleticalboy.github.io{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"><div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>{categories}</div><div><i class="fa fa-tag fa-fw"></i>{tags}</div></div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>' }); </script>
